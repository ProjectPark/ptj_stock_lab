# PTJ 매매법 attach v3 — 매매 규칙서 (레짐 감지 + Optuna 최적화)

> 작성일: 2026-02-25 | 기반: attach v2 + Study 5(레짐 감지) + D2S v3 Regime Optuna #449
> attach v3 핵심 방향: **레짐(Bull/Bear/Neutral) 판정에 따른 청산 파라미터 동적 전환 + BB 하드 진입 필터로 OOS 방어**

---

## attach v2 → attach v3 변경 요약

| 항목 | attach v2 | attach v3 (Optuna #449 반영) | 효과 |
|---|---|---|---|
| BB 진입 필터 | %B ≤ 0.6 우대 (소프트) | **%B ≤ 0.30 하드 필터 (R19)** | OOS +13.2%p, MDD -8.5%p |
| 이익실현 기준 | +5.9% 고정 | **Bull=5.0%, Bear=6.5% 레짐별** | IS/OOS 트레이드오프 해소 |
| 최대 보유일 | 7일 고정 | **Bull=12일, Bear=8일 레짐별** | OOS 손실 방어 |
| GLD 억제 기준 | GLD ≥ +1.0% | **GLD ≥ +0.5% (민감화)** | 리스크오프 조기 감지 |
| RSI 진입 범위 | 40~60 | **37~69** | 진입 기회 확대 |
| 역발상 기준 | 종목 0% 이하 | **종목 -0.5% 이하** | 진입 품질 강화 |
| V-바운스 발동 | crash -10%, %B<0.15, score≥0.87 | **crash -12%, %B<0.2, score≥0.9** | 발동 정밀화 |
| V-바운스 확대 | 2.0배 | **2.5배** | 대박 이벤트 극대화 |
| 조기 손절 | 3일 내 +2% 미회복 | **2일 내 +3% 미회복** | 더 빠른 손절 판단 |
| DCA 일일 한도 | 5회 | **2회** | 과도한 DCA 방지 |
| 기본 매수 비중 | 15% | **10%** | 포지션 분산 강화 |
| 레짐 감지 | 없음 | **SPY streak + SMA12 + Polymarket 3차원** | 시장 국면 적응 |

> Optuna 검증 결과: IS +33.68% / OOS +62.42% (Sharpe 2.22/1.46), MDD -9.2%/-16.0%
> 검증 기간: IS 2024-09-18 ~ 2025-05-31 / OOS 2025-06-01 ~ 2026-02-17 (no-ROBN 1.5년)

---

## 0. 검증 기반

### 0-1. Study 5 레짐 감지 스터디 결론

| 레짐 | Bull | Bear | Neutral |
|---|---|---|---|
| 판정 기준 | SPY streak ≥ 5일 OR SMA12+1.1% 이상 OR BTC_up > 0.55 (2/3 다수결) | SPY 하락 streak ≥ 1일 OR SMA12-1.5% 이하 OR BTC_up < 0.35 (2/3 다수결) | 그 외 |
| 청산 전략 | tp=5.0%, hd=12일 | tp=6.5%, hd=8일 | tp=5.0%, hd=8일 (bear와 동일) |
| 근거 | 빠른 익절로 이익 확정 | 더 기다려서 반등 포착 | 보수적 운영 |

> ※ Optuna #449 역전 발견: Bull 레짐에서도 tp=5.9%보다 5.0%가 최적. 빠른 익절이 레짐 무관 유리함.

### 0-2. Optuna #449 핵심 성과

| 기간 | 수익률 | MDD | Sharpe |
|---|---|---|---|
| IS (2024-09 ~ 2025-05) | +33.68% | -9.2% | 2.220 |
| OOS (2025-06 ~ 2026-02) | +62.42% | -16.0% | 1.461 |
| 전체 (1.5년, no-ROBN) | +118.05% | -16.0% | 1.506 |

---

## 1. 시황 판단 — 다차원 필터 (v2 계승 + 파라미터 업데이트)

### 1-1. GLD 시황 필터 (R1)

| GLD 구간 | 행동 |
|---|---|
| GLD < +0.5% | 기본 매수 |
| **GLD ≥ +0.5%** | **매수 억제 (v3: 1.0% → 0.5% 강화)** |

> v2 대비 변경: `gld_suppress_threshold` 1.0% → 0.5% (리스크오프 조기 감지)

### 1-2. BTC 확률 필터 (R3)

| BTC up 확률 | 행동 |
|---|---|
| < 0.40 | 매수 억제 |
| 0.40 ~ 0.70 | 기본 매수 |
| **> 0.70** | **매수 억제 (v3: 0.75 → 0.70 강화)** |

### 1-3. SPY×GLD 리스크오프 역발상 매수 (R14)

| 구간 | 조건 | 행동 |
|---|---|---|
| 패닉 | SPY < **-2.8%** (v3: -1.5% → -2.8%) | R14 미발동, 비중 0.6배 축소 |
| 기본 발동 | GLD↑ + SPY↓ | R14 발동 (매수 우대) |
| 최적 구간 | GLD ≥ **+0.7%** + SPY ≤ **-0.6%** | 최강 매수 신호 |
| 연속 발동 | 연속 **2일** 이상 (v3: 3 → 2) | 특급 신호 +10% 보너스 |

### 1-4. SPY 연속 상승 후 매수 금지 (R13)

| SPY 스트릭 | 행동 |
|---|---|
| **3일+ 연속 상승** | 매수 금지 |

---

## 2. 쌍둥이 갭 진입 — OOS 필터 강화 (v3)

### 2-1. OOS Decision Tree (v3 업데이트)

```
IF gap_bank_CONL ≤ 5.0%  (v3: 6.3% → 5.0%)
  AND ROBN_pct ≤ +2.5%   (v3: 2.1% → 2.5%)
  AND poly_btc_up ≤ 0.70  (v3: 0.75 → 0.70)
    → BUY
ELSE
    → HOLD
```

---

## 3. 기술적 지표 진입 필터 (v3 업데이트)

### 3-1. RSI(14) 진입 구간

| RSI 구간 | 행동 |
|---|---|
| **< 37** | 진입 가능 (v3: 하한 40 → 37 완화) |
| **37~69** | **최적 진입 (v3: 40~60 → 37~69 확대)** |
| 69~76 | 주의 (과열 접근) |
| **> 76** | **진입 금지 (v3: 80 → 76 강화)** |

### 3-2. 볼린저밴드 %B 구간 (R8 + R19 v3 핵심)

| %B 구간 | 분류 | 행동 |
|---|---|---|
| **> 0.30** | **하드 차단 구간** | **R19: 진입 절대 금지 (Study G F2: OOS +13.2%p)** |
| < 0 | 충격 과매도 | R17/R18 적용 (V-바운스 모드) |
| 0.0 ~ 0.20 | 강한 과매도 | 강한 매수 신호 |
| **0.20 ~ 0.30** | **최적 진입 (v3)** | 최적 구간 |
| > 0.40 (v3 bb_entry_max) | 밴드 중심+ | 소극적 진입 |
| **> 1.1** | **극도 과열** | **R8: 진입 금지** |

> **R19 하드 필터**: %B > 0.30이면 갭 진입·역발상·리스크오프 무관 진입 금지.
> 근거: Study G F2 — FULL +12.3%p, OOS +13.2%p, Sharpe +0.239

### 3-3. ATR 고변동 진입 (R16)

| ATR 사분위 | 행동 |
|---|---|
| **≥ 65번째 백분위 (v3: 75 → 65)** | **진입 우대** |
| < 65 | 소극적 |

### 3-4. 상대 거래량

| 상대 거래량 | 행동 |
|---|---|
| **1.1~3.5x (v3: 1.2~2.0 → 1.1~3.5)** | 진입 허용 |
| < 1.1 또는 > 3.5 | 이상 거래량 — 소극적 |

---

## 4. 진입 조건

### 4-1. 역발상 진입 기준 (v3 강화)

| 구분 | v2 기준 | v3 기준 | 근거 |
|---|---|---|---|
| 기본 역발상 | 종목 0.0% 이하 | **종목 -0.5% 이하** | Optuna #449 |
| AMDL 금요일 | -1.5% 이하 | **-3.0% 이하** | Optuna #449 |

### 4-2. V-바운스 패턴 진입 (R17, v3 업데이트)

**발동 조건** (ALL 충족):

| 조건 | v2 기준 | v3 기준 (Optuna) | 근거 |
|---|---|---|---|
| BB(%B) 극도 과매도 | %B < 0.15 | **%B < 0.20** | Optuna #449 |
| 단기 충격 하락 | crash < -10% | **crash < -12%** | Optuna #449 |
| 진입 점수 | ≥ 0.87 | **≥ 0.90** | Optuna #449 |
| 리스크오프 동반 | GLD↑+SPY↓ OR ATR Q4 | 동일 | — |

**행동**:

```
기본 buy_size = 10% ($1,500)
R17 V-바운스 ALL 충족 시:
  → buy_size = min(10% × 2.5, 30%) = 25% ($3,750)  [v3: 2.0배 → 2.5배]
  → 동시에 R18 조기 손절 활성화
```

---

## 5. DCA 규칙 (v3 강화)

| 레이어 | 허용 여부 | 근거 |
|---|---|---|
| 0~2레이어 | 허용 | 승률 67~100% |
| **3레이어+** | **강력 억제 (v2 계승)** | 승률 27% |
| **일일 동일종목 매수** | **최대 2회 (v3: 5회 → 2회)** | Optuna #449 |

---

## 6. 레짐 감지 (v3 핵심 신규)

### 6-1. 3차원 레짐 신호

| 신호 | Bull 조건 | Bear 조건 | Neutral |
|---|---|---|---|
| **SPY streak** | SPY 연속 상승 **≥ 5일** (v3: 3→5) | SPY 연속 하락 **≥ 1일** (v3: 2→1) | 그 외 |
| **SPY SMA12** | SPY > SMA + **1.1%** | SPY < SMA - **1.5%** | 그 외 |
| **Polymarket BTC** | btc_up > **0.55** (v3: 0.60→0.55) | btc_up < **0.35** (v3: 0.40→0.35) | 그 외 |

**복합 판정**: 3개 신호 중 2개 이상 일치 → 레짐 확정 (다수결)

### 6-2. 레짐별 청산 파라미터 (R20/R21, v3 핵심)

| 레짐 | take_profit (R20) | hold_days (R21) | Optuna 근거 |
|---|---|---|---|
| **Bull** | **5.0%** (기존 5.9% → 역전) | **12일** (기존 7→12) | Optuna #449 |
| **Bear** | **6.5%** (기존 5.0% → 상향) | **8일** (기존 4→8) | Optuna #449 |
| **Neutral** | 5.0% (Bear와 동일) | 8일 (Bear와 동일) | — |

> ※ 역전 발견: Bull 레짐에서 tp=5.0%이 5.9%보다 우월. 이익 빠른 확정이 레짐 무관 유효.

---

## 7. 청산 규칙 (v3 업데이트)

### 7-1. 이익실현 (R20, 레짐 조건부)

| 레짐 | 이익실현 기준 |
|---|---|
| Bull | **+5.0% 이상** |
| Bear/Neutral | **+6.5% 이상** |

### 7-2. 강제청산 (R21, 레짐 조건부)

| 레짐 | 최대 보유일 |
|---|---|
| Bull | **12거래일** |
| Bear/Neutral | **8거래일** |

### 7-3. BB 하단 돌파 조기 손절 (R18, v3 업데이트)

| 조건 | v2 기준 | v3 기준 |
|---|---|---|
| 모니터링 기간 | 진입 후 **3일** | **2일** (더 빠른 판단) |
| 성공 판단 기준 | +2% 이상 회복 | **+3% 이상 회복** (더 높은 기준) |

```
%B < 0 진입 포지션 모니터링:
  Day 1: +3% 이상 회복? → V-바운스 성공 가능, 유지
  Day 2: +3% 이상 회복? → 유지
  Day 3 (진입 후 2일): 미회복 → 전량 손절
```

---

## 8. 포지션 사이징 (v3 업데이트)

| 진입 유형 | v2 기본 사이즈 | v3 기본 사이즈 | V-바운스 확대 |
|---|---|---|---|
| 갭 진입 / 역발상 | 15% | **10%** | R17 조건 시 25% |
| 소형 탐색 | 5% | **5%** | 없음 |
| 일일 신규 진입 한도 | 30% | **15%** | — |

---

## 9. 자동매매 루프 — attach v3

```
매 30분 반복:

  ── 0차: 레짐 감지 ──
  0. SPY streak + SMA12 + Polymarket BTC 3차원 레짐 판정 (R20/R21용)

  ── 1차: 시황 필터 ──
  1. GLD 시황 필터 (R1) → GLD ≥ +0.5% 시 매수 억제 (v3 강화)
  2. BTC 확률 필터 (R3) → poly_btc_up > 0.70 시 관망 (v3 강화)
  3. confidence_signal 확인 → 활성 시 관망
  4. GLD↑+SPY↓ 리스크오프 감지 (R14) → YES면 V-바운스 모드 준비
  5. SPY 3일+ 연속 상승 확인 (R13) → YES면 매수 금지

  ── 2차: 기술적 필터 ──
  6. RSI(14) 확인 (R7) → 37~69 구간, >76 금지 (v3 범위)
  7. BB %B 확인 (R8+R19)
     - %B > 0.30 → 하드 차단 (R19 신규)
     - %B > 1.1  → 금지 (R8)
     - %B < 0    → R17 V-바운스 체크 진행
  8. MACD 콤보 확인 (R9)
  9. ATR ≥ 65분위 확인 (R16, v3: 75→65)

  ── 3차: V-바운스 체크 (R17 v3 파라미터) ──
  10. %B < 0.20 + crash < -12% + score ≥ 0.90 + 리스크오프 신호?
      → ALL YES: V-바운스 확대 모드 (buy_size × 2.5) + R18 활성화
      → PARTIAL: 기본 진입

  ── 4차: 진입 실행 ──
  11. 쌍둥이 갭 스캔 (R2) → OOS 규칙 기반 (gap≤5.0%, ROBN≤+2.5%, btc≤0.70)
  12. 역발상 진입 (R6) → 종목 -0.5% 이하 시 진입 (v3 강화)
  13. DCA 일일 횟수 확인 → 2회 이상 시 금지 (v3 강화)

  ── 5차: 청산 스캔 ──
  14. R20 레짐 조건부 이익실현 (Bull=+5.0%, Bear=+6.5%)
  15. R18 조기 손절 스캔 → %B<0 진입 포지션 + 2일 경과 + 수익률 < +3% → 손절
  16. R21 레짐 조건부 강제청산 (Bull=12일, Bear=8일)
```

---

## 10. 규칙 목록 (R1~R21)

| ID | 규칙명 | 조건 | v3 변경 | 유형 |
|---|---|---|---|---|
| R1 | GLD 시황 필터 | GLD ≥ +0.5% → 억제 | 1.0% → **0.5%** | 진입 필터 |
| R2 | 쌍둥이 갭 진입 | gap≤5.0%, ROBN≤2.5%, btc≤0.70 | gap 6.3→**5.0%**, btc **0.70** | 진입 조건 |
| R3 | BTC 확률 필터 | poly_btc_up ≤ 0.70 | 0.75 → **0.70** | 시황 판단 |
| R4 | 이익실현 매도 | R20으로 통합 | → R20 참조 | — |
| R5 | DCA 레이어 제한 | 3레이어+ 억제 (v2 계승) | 일일 5 → **2회** | 사이징 규칙 |
| R6 | 하락장 역발상 매수 | 종목 -0.5% 이하 | 0.0% → **-0.5%** | 진입 조건 |
| R7 | RSI 진입 필터 | RSI 37~69, >76 금지 | 40~60 → **37~69**, 80 → **76** | 기술적 필터 |
| R8 | 볼린저밴드 필터 | %B > 1.1 금지 | 1.0 → **1.1** | 기술적 필터 |
| R9 | MACD 콤보 | v2 계승 | 동일 | 기술적 콤보 |
| R10 | 오프닝 회피 | v2 계승 | 동일 | 장중 타이밍 |
| R11 | 갭다운 진입 | v2 계승 | 동일 | 장중 필터 |
| R12 | 상대 거래량 필터 | 1.1~3.5x | 1.2~2.0 → **1.1~3.5** | 장중 필터 |
| R13 | SPY 스트릭 필터 | 3일+ 연속 상승 후 금지 | 동일 | 시황 필터 |
| R14 | 리스크오프 매수 | GLD↑+SPY↓, 패닉 -2.8% | -1.5 → **-2.8%** | 시황 조건 |
| R15 | 금요일 우대 | v2 계승 | 동일 | 캘린더 필터 |
| R16 | ATR 고변동 진입 | ATR ≥ 65분위 | 75 → **65분위** | 기술적 필터 |
| R17 | 충격 V-바운스 확대 | %B<0.20 + crash<-12% + score≥0.90 | 0.15/-10%/0.87 → **0.20/-12%/0.90**, ×**2.5** | 사이징 확대 |
| R18 | BB 하단 조기 손절 | %B<0 진입 후 2일 내 +3% 미회복 | 3일/+2% → **2일/+3%** | 손절 규칙 |
| **R19** | **BB 하드 진입 필터** | **%B > 0.30 → 전 진입 유형 금지** | **v3 신규 (Study G F2)** | **진입 차단** |
| **R20** | **레짐 조건부 TP** | **Bull=5.0%, Bear=6.5%** | **v3 신규 (Study 5 + Optuna)** | **청산 조건** |
| **R21** | **레짐 조건부 HD** | **Bull=12일, Bear=8일** | **v3 신규 (Study 5 + Optuna)** | **청산 조건** |

---

## 부록 A. 파라미터 요약 (v3 전체)

| 파라미터 | v2 값 | v3 값 (Optuna #449) | 변경 이유 |
|---|---|---|---|
| `gld_suppress_threshold` | 1.0% | **0.5%** | 리스크오프 조기 감지 |
| `btc_up_max` | 0.75 | **0.70** | BTC 억제 강화 |
| `gap_bank_conl_max` | 6.3% | **5.0%** | 갭 필터 강화 |
| `robn_pct_max` | 2.1% | **2.5%** | Optuna |
| `riskoff_spy_min_threshold` | -1.5% | **-2.8%** | 패닉 구간 확장 |
| `riskoff_gld_optimal_min` | 0.5% | **0.7%** | Optuna |
| `riskoff_spy_optimal_max` | -0.5% | **-0.6%** | Optuna |
| `riskoff_consecutive_boost` | 3일 | **2일** | 연속 리스크오프 민감화 |
| `riskoff_panic_size_factor` | 0.5 | **0.6** | Optuna |
| `market_score_suppress` | 0.40 | **0.45** | 진입 기준 강화 |
| `market_score_entry_b` | 0.55 | **0.70** | Optuna |
| `market_score_entry_a` | 0.60 | **0.80** | Optuna |
| `rsi_entry_min` | 40 | **37** | Optuna |
| `rsi_entry_max` | 60 | **69** | Optuna |
| `rsi_danger_zone` | 80 | **76** | Optuna |
| `bb_entry_max` | 0.6 | **0.4** | Optuna |
| `bb_danger_zone` | 1.0 | **1.1** | Optuna |
| `bb_entry_hard_max` | — | **0.30 (R19)** | Study G F2 |
| `atr_high_quantile` | 0.75 | **0.65** | Optuna |
| `vol_entry_min` | 1.2 | **1.1** | Optuna |
| `vol_entry_max` | 2.0 | **3.5** | Optuna |
| `contrarian_entry_threshold` | 0.0% | **-0.5%** | Optuna |
| `amdl_friday_contrarian_threshold` | -1.5% | **-3.0%** | Optuna |
| `vbounce_bb_threshold` | 0.15 | **0.20** | Optuna |
| `vbounce_crash_threshold` | -10.0% | **-12.0%** | Optuna |
| `vbounce_score_threshold` | 0.87 | **0.90** | Optuna |
| `vbounce_size_multiplier` | 2.0 | **2.5** | Optuna |
| `early_stoploss_days` | 3일 | **2일** | Optuna |
| `early_stoploss_recovery` | +2.0% | **+3.0%** | Optuna |
| `buy_size_large` | 15% | **10%** | Optuna |
| `daily_new_entry_cap` | 30% | **15%** | Optuna |
| `dca_max_daily` | 5회 | **2회** | Optuna |
| `bull_take_profit_pct` | 5.9% | **5.0% (역전)** | Optuna #449 |
| `bear_take_profit_pct` | 5.0% | **6.5%** | Optuna #449 |
| `bull_hold_days_max` | 7일 | **12일** | Optuna #449 |
| `bear_hold_days_max` | 4일 | **8일** | Optuna #449 |
| `regime_bull_spy_streak` | 3일 | **5일** | Optuna #449 |
| `regime_bear_spy_streak` | 2일 | **1일** | Optuna #449 |
| `regime_spy_sma_period` | 20일 | **12일** | Optuna #449 |
| `regime_spy_sma_bull_pct` | +1.0% | **+1.1%** | Optuna #449 |
| `regime_spy_sma_bear_pct` | -1.0% | **-1.5%** | Optuna #449 |
| `regime_btc_bull_threshold` | 0.60 | **0.55** | Optuna #449 |
| `regime_btc_bear_threshold` | 0.40 | **0.35** | Optuna #449 |

---

## 부록 B. 실험 스크립트 참조

| 스크립트 | 역할 |
|---|---|
| `simulation/strategies/line_c_d2s/d2s_engine.py` | D2S 신호 엔진 (R1~R19 구현) |
| `simulation/strategies/line_c_d2s/params_d2s.py` | D2S 파라미터 (v1/v2/v3/no-robn) |
| `simulation/backtests/backtest_d2s_v3.py` | D2S v3 백테스트 (R19/R20/R21 레짐 조건부) |
| `simulation/optimizers/optimize_d2s_v3_regime_optuna.py` | D2S v3 Regime Optuna (~45 파라미터) |
| `experiments/study_1layer_backtest.py` | Study G (BB 필터 검증) |
| `experiments/study_exit_params.py` | Study H (청산 파라미터 그리드) |

---

## 부록 C. v3 검증 결과 (no-ROBN 1.5년)

| Trial | Score | IS 수익률 | OOS 수익률 | IS Sharpe | OOS Sharpe |
|---|---|---|---|---|---|
| **#449 (Best)** | **46.80** | **+33.68%** | **+62.42%** | **2.220** | **1.461** |
| #491 | 46.76 | +34.65% | +61.50% | 2.296 | 1.421 |
| #446 | 46.33 | +36.50% | +57.92% | 2.379 | 1.358 |

> Full 기간 (1.5년 no-ROBN): +118.05%, MDD -16.0%, Sharpe 1.506
> 스코어 함수: IS_Sharpe×10 + OOS_Sharpe×20 - |MDD|×0.5 (OOS 2배 가중)

---

## 부록 D. 다음 검증 과제 (v4 후보)

| 과제 | 내용 |
|---|---|
| ROBN 포함 1년 검증 | ROBN 상장(2025-01-31) 이후 4종목 v3 백테스트 |
| 상승장 v3 성능 | IS(bull market) 구간에서 R19/R20/R21 조합 성능 확인 |
| Polymarket 레짐 단독 효과 | BTC up 확률 레짐 신호만의 기여도 분리 |
| market_score_weights 재탐색 | GLD 비중 0.2273이 여전히 최적인지 장기 검증 |
