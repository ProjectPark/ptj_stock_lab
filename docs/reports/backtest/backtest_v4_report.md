# PTJ 매매법 v4 — 백테스트 시뮬레이션 리포트

> 실행일: 2026-02-23 | 엔진: `backtest_v4.py` | 규칙서: `docs/rules/line_a/trading_rules_v4.md`

---

## 시뮬레이션 기간: 2025-02-18 ~ 2026-01-30 (240 거래일)

---

## 1. 시뮬레이션 설정

| 항목 | 값 |
|---|---|
| 기간 | 2025-02-18 ~ 2026-01-30 (240 거래일) |
| 초기 자금 | $15,000 |
| 데이터 | 5분봉 `data/market/ohlcv/` + 일봉 캐시 |
| 수수료 | KIS 미국주식 기준 (매수/매도 포함) |
| 총 수수료 | $676 (v2 $7,891 대비 91% 절감) |

---

## 2. v3 → v4 변경 요약

v4의 핵심 방향은 **절대적 회피 규칙 + ATR 기반 손절 + 횡보장 기술적 감지 강화**이다.

| 항목 | v3 | v4 | 효과 |
|---|---|---|---|
| 시장 서킷 브레이커 | — | **절대적 회피 규칙 6종** | 횡보장·폭락 시 현금 보유로 자본 보전 |
| 진입 시간 | 10:30 ET 고정 | **조건부 9:45 / 10:00 ET** | 강한 추세 시 조기 진입 허용 |
| 필터 순서 | 시간→횡보→진입 | **횡보→시간→진입** | 횡보장 우선 차단, 불필요 진입 감소 |
| 횡보장 지표 | Polymarket 등 5개 | **기술적 6개 지표** (ATR/RSI/BB 등) | 실전 차단력 강화 |
| 손절 | 고정 -3% | **ATR 기반 변동 손절** | 손절 횟수 감소, MDD 개선 |
| CONL 진입 | 트리거만 확인 | **ADX + EMA 기울기 필터 추가** | 횡보장 CONL 손실 방지 |
| CONL 매수 금액 | $2,250 + 물타기 | **$6,750 고정, 물타기 금지** | 단일 진입으로 리스크 명확화 |
| 과열 종목 전환 | — | **레버리지 → 비레버리지 전환** | 과열 후 급락 리스크 회피 |
| 급등 스윙 전략 | — | **+15% 급등 시 8개월 스윙 사이클** | 단기 매매 중단 + 장기 수익 극대화 |
| 급락 역매수 | — | **-40% 급락 시 95% 역매수** | 패닉셀 이후 갭상승 포착 |

---

## 3. 전략 아키텍처

### 3-1. 시장 모드 분류 체계

v4는 **5단계 시장 모드**를 운영한다. 우선순위: **회피 > 횡보장 > 하락장 > 강세장 > 일반**

| 모드 | 판단 기준 | 행동 |
|---|---|---|
| **회피** | 서킷 브레이커(CB) 발동 | 매수·매도 금지 (CB 유형에 따라 차등) |
| **횡보장** | 기술적 6개 지표 중 3개 이상 충족 | 현금 100%, 신규 매수 전면 금지 |
| **하락장** | Polymarket 코인·나스닥·이더 3종 ≤ 20% | BRKU 10% + 현금 90% |
| **강세장** | Polymarket 상승확률 ≥ 70% | 손절 ATR 완화 + 보유 익일까지 연장 |
| **일반** | 위 해당 없음 | 기본 규칙대로 매매 |

### 3-2. 서킷 브레이커 (v4 신규 6종)

모든 매매 규칙보다 **최우선** 적용된다.

| CB | 조건 | 제한 내용 | 기간 |
|---|---|---|---|
| CB-1 | VIX 일간 **+6%** 이상 | 모든 매수·매도 금지 | 7거래일 |
| CB-2 | GLD 일간 **+3%** 이상 | 모든 매수·매도 금지 | 3거래일 |
| CB-3 | BTC 일간 **-5%** 이상 | 모든 매수·매도 금지 | 조건 해제 시까지 |
| CB-4 | BTC 일간 **+5%** 이상 | 추격매수만 금지 | 조건 해제 시까지 |
| CB-5 | Polymarket 금리 상승 **≥ 50%** | 레버리지 ETF 전면 금지 | 확률 50% 미만 시 해제 |
| CB-6 | 레버리지 종목 **+20%** 이상 | 비레버리지 대체 종목으로 전환 | 고점 대비 -10% 조정 시 해제 |

### 3-3. 횡보장 감지 — 기술적 6개 지표

6개 중 **3개 이상** 충족 시 횡보장 모드 진입. 30분 간격으로 재평가.

| # | 지표 | 횡보장 조건 |
|---|---|---|
| 1 | ATR 감소 | 14일 ATR이 20일 평균 대비 **20% 이상** 감소 |
| 2 | 거래량 감소 | 20일 평균 거래량 대비 **30% 이상** 감소 |
| 3 | 20 EMA 평평 | 20 EMA 기울기 절대값 **0.1% 이하** (5일 기준) |
| 4 | RSI 박스권 | RSI(14) **45~55** 범위 |
| 5 | BB 폭 축소 | 볼린저밴드(20,2) 폭이 60일 **하위 20%** |
| 6 | 고저점 차이 | 당일 고가-저가 차이 **2% 이하** |

> v3 대비 변경: Polymarket/GLD 기반 5개 지표 → 기술적 분석 6개 지표로 전면 교체.
> v3의 실전 차단 0건 문제를 해결.

### 3-4. 매수 전략 구성

| 전략 | 진입 조건 | 금액 |
|---|---|---|
| **쌍둥이 갭** (ENTRY) | lead-follow 갭 ≥ 2.2% | $2,250 (초기) + $750 × 최대 4회 |
| **조건부 COIN** | ETHU+XXRP+SOLT 각각 ≥ +4.5% | 일반 규칙 |
| **조건부 CONL** | 동상 + ADX ≥ 18 + EMA 기울기 양수 | **$6,750 고정, 물타기 금지** |
| **SOXL·CONL·IRE 고정 익절** | 갭 매수 후 40/60 분할 | 40%: 갭 수렴(0.9%) / 60%: +5% 고정 TP |
| **급락 역매수** | SOXL/CONL/IRE 당일 ≤ -40% | 총 투자금의 95%, 장마감 5분 전(15:55) |
| **급등 스윙** | 대상 종목 일간 ≥ +15% | 투자금의 90%, 3개월 보유 후 GLD 전환 |
| **VIX 스윙** | VIX 일간 ≥ +6% | GLD 80%, 5개월 보유 후 3개월 매매 금지 |

### 3-5. 손절 체계 (ATR 기반 전면 개편)

| 유형 | 조건 | 손절 기준 |
|---|---|---|
| **ATR 손절** (일반) | 기본 | 진입가 - **1.5 × ATR14** |
| **ATR 손절** (강세장) | Polymarket ≥ 70% | 진입가 - **2.5 × ATR14** |
| **고변동성 손절** | 최근 5거래일 ±10% 2회 이상 | 진입가 대비 **-4%** 고정 |
| **시간 손절** (일반) | 매수 후 **5시간** 경과 | 수익/손실 무관 자동 매도 |
| **시간 손절** (강세장) | Polymarket ≥ 70% | **익일까지** 연장, 양전+순수익 시 매도 |

---

## 4. 백테스트 결과 — Baseline (규칙서 기본값)

| 지표 | v2 | v3 | **v4** | v5 |
|---|---|---|---|---|
| 초기 자금 | $15,000 | ₩20,000,000 | **$15,000** | $15,000 |
| 최종 자산 | $9,353 | ₩16,406,458 | **$18,823** | $12,947 |
| **총 수익률** | -37.65% | -17.97% | **+25.49%** | -13.68% |
| **MDD** | 37.65% | 17.97% | **9.34%** | 14.17% |
| **Sharpe** | -3.1056 | -2.3310 | **1.3659** | -2.6256 |
| 총 손익 | -$5,647 | -₩3,593,542 | **+$3,823** | -$2,053 |
| 매수 횟수 | 867 | 397 | **21** | 139 |
| 매도 횟수 | 3,096 | 1,857 | **85** | 904 |
| 승률 | 40.8% | 52.6% | 38.8% | 40.3% |
| 총 수수료 | $7,891 | ₩5,809,597 | **$676** | $1,904 |

> v2~v3~v5 모두 손실. v4만 유일하게 수익. CB와 서킷브레이커가 시장 하락 방어에 효과적.

---

## 5. Optuna 최적화 결과 — Phase 1

**Study**: `ptj_v4_phase1` | **400 Trials** | **TPE 방식**
**Best Trial**: #388 | **Score = +30.43** (전체 8개 Study 중 최고)

### 5-1. Baseline vs Best #388 핵심 비교

| 지표 | Baseline | Best #388 | 변화 |
|---|---|---|---|
| 수익률 | +25.74% | **+32.44%** | +6.70%p |
| Balanced Score | +23.73 | **+30.43** | +6.70 |
| MDD | -9.34% | **-9.34%** | — |
| Sharpe | 1.3774 | **1.6496** | +0.27 |
| 승률 | 40.4% | **70.2%** | +29.8%p |
| 매수 횟수 | 21회 | **15회** | -6회 |
| CB 차단 | 1,644회 | **717회** | -927회 |
| 횡보장 감지일 | 37일 | **122일** | +85일 |

### 5-2. 주요 파라미터 최적값

| 파라미터 | Baseline | Best #388 | 해석 |
|---|---|---|---|
| `PAIR_GAP_SELL_THRESHOLD_V2` | 0.9% | **6.6%** | 갭 수렴 매도 기준 대폭 상향 |
| `STOP_LOSS_BULLISH_PCT` | -8.0% | **-16.0%** | 강세장 손절 크게 완화 |
| `V4_CB_VIX_SPIKE_PCT` | 6.0% | **3.0%** | VIX CB 기준 낮춰 더 민감하게 |
| `V4_CB_VIX_COOLDOWN_DAYS` | 7일 | **13일** | VIX 쿨다운 연장 |
| `V4_DCA_MAX_COUNT` | 4회 | **1회** | 물타기 거의 안 함 |
| `V4_SIDEWAYS_ATR_DECLINE_PCT` | 20% | **10%** | 횡보 감지 민감도 2배 |
| `V4_SIDEWAYS_RSI_HIGH/LOW` | 55/45 | **65/35** | 횡보 RSI 범위 대폭 확대 |
| `V4_CONL_ADX_MIN` | 18.0 | **10.0** | CONL 진입 조건 완화 |
| `V4_PAIR_FIXED_TP_PCT` | 5.0% | **7.5%** | 고정 익절 목표 상향 |

### 5-3. v4 파라미터 중요도 (fANOVA)

| 파라미터 | 중요도 | 해석 |
|---|---|---|
| `V4_PAIR_GAP_ENTRY_THRESHOLD` | **29.1%** | 페어 진입 갭 기준 — 압도적 1위 |
| `V4_SIDEWAYS_POLY_HIGH` | 14.5% | 횡보장 Polymarket 판단 기준 |
| `V4_CB_BTC_SURGE_PCT` | 9.7% | BTC 급등 CB 기준 |
| `V4_MAX_PER_STOCK` | 4.3% | 종목당 최대 투입 금액 |
| `DCA_DROP_PCT` | 3.8% | 물타기 트리거 하락률 |

---

## 6. 시그널별 상세 분석 (Best #388 기준)

### 6-1. swing_stage2 — 핵심 이익원 (★★★)

**2회 진입, 100% 승률, +$6,103.86 (총 수익의 125%)**

| # | 진입 | 종목 | 청산 | 보유 | P&L |
|---|---|---|---|---|---|
| 1 | 2025-03-13 | GLD | 2025-08-13 | **153.8일** | +$1,260.09 (+12.8%) |
| 2 | 2025-08-29 | GLD | 2026-01-30 | **154.0일** | +$4,843.77 (+46.1%) |

- GLD(금 ETF)만 활용 — 시장 충격(3월, 8월) 직후 금 강세 사이클 추종
- ~5개월 장기 보유 후 `swing_stage2_maturity` 만기 청산
- **⚠️ 재현 가능성 리스크**: 2회 표본, 모두 GLD, 금 강세장 의존

### 6-2. swing_stage1 — 지속적 손실 (🔴)

**2회 진입, 0% 승률, -$2,255.20**

| # | 진입 | 종목 | 손절 원인 | 보유 | P&L |
|---|---|---|---|---|---|
| 1 | 2025-03-11 | CONL | drawdown_stop (-15% 이탈) | 46.7h | -$1,479.83 |
| 2 | 2025-08-29 | IRE | atr_stop | 1.73h | -$775.37 |

> swing_stage2가 시작되기 직전/직후에 swing_stage1 손실 발생. Phase 2 방향: swing_stage1 완전 비활성화 후 swing_stage2만 유지.

### 6-3. twin — 안정적 이익원 (✅)

**6회 매수, 72.1% 승률, +$785.22**

| 청산 방식 | 횟수 | 특징 |
|---|---|---|
| staged_sell | 35회 | 분할 청산 주력 (5분 간격) |
| twin_converge | 4회 | 즉시 수렴 청산 (~16분 이내) |
| fixed_tp | 1회 | +7.5% TP 달성 (+$212.96) |
| stop_loss | 1회 | -$33.25 (-3.25%) |

핵심 사례: 2025-03-06 MSTU — 28회 분할매도로 **+$399** 확보.

### 6-4. conditional_conl — 대폭 개선 (✅)

Baseline 대비 진입 횟수 39→**2회**, 승률 5.1%→**70.6%**, P&L -$158→**+$119.68**

| 개선 파라미터 | Baseline | Best | 효과 |
|---|---|---|---|
| VIX Cooldown | 7일 | **13일** | VIX 급등 후 13일 진입 차단 |
| CONL EMA Slope | 0% | **+0.5%** | 상승 모멘텀 확인 시만 진입 |
| VIX CB 발동 | +6% | **+3%** | 더 보수적 진입 차단 |

---

## 7. 수익 구조 분해

```
총 수익: +$4,864 (수수료 차감 후)

├── swing_stage2_maturity  +$6,103.86  (수익의 125%)  ← 핵심 레버
├── twin (staged_sell 등)    +$785.22  (수익의 16%)   ← 안정원
├── conditional_conl          +$119.68  (수익의 2%)    ← 소규모
├── conditional_coin          +$113.08  (수익의 2%)    ← 소규모
├── swing_stage1            -$2,255.20  (손실의 -46%) ← 최대 리스크
└── 기타 (stop_loss 등)        -$2.57   (무시 가능)
```

### 수익의 주요 패턴

- 수익의 **125%**가 swing_stage2에서 발생 — 나머지 단기 매매 전체는 손익 기준 플러스이지만 swing_stage1 손실이 상쇄
- **초단기(당일 1~3시간)** 위주 운영 + **swing_stage2만 ~5개월 장기** 보유
- 2025년 3월 / 8월 두 차례 시장 충격 이후 GLD 강세 사이클 포착이 핵심

---

## 8. 거래 집중도 분석

| 기간 | 주요 활동 |
|---|---|
| 2025-02 | CONL/MSTU twin 진입 — 장 초반 변동성 활용 |
| 2025-03 | MSTU twin +$399 + CONL swing1 -$1,479 + GLD swing2 진입 |
| 2025-03~08 | GLD 장기 보유 (거래 없음) |
| 2025-08-20~22 | IRE/CONL/COIN 집중 진입 (4일간 대부분 거래) |
| 2025-08-29 | IRE swing1 손실 + GLD swing2 진입 |
| 2025-08~01 | 2번째 GLD 장기 보유 (2026-01-30 만기) |

---

## 9. 차단 효율 분석

| 항목 | Baseline | Best #388 | 비고 |
|---|---|---|---|
| CB 매수 차단 | 1,630회 | 717회 | -56%, 과도 차단 해소 |
| 횡보장 감지일 | 37일 | 122일 | +85일, ATR/Volume 민감도 강화 효과 |
| conditional_conl 진입 | 39회 | 2회 | VIX 쿨다운 강화로 고변동성 회피 |

> v5의 CB 과도 차단(22,766회) 대비 v4(1,630회)는 균형적. v5에서 과잉 방어로 수익 기회 차단됨.

---

## 10. 규칙↔코드 커버리지

Line A v1~v5 전체: **25/25 (100%)** 구현 완료

| Rule ID | 설명 | 코드 위치 |
|---|---|---|
| CB-1~6 | 서킷 브레이커 6종 | `backtest_v4.py:_record_cb_event` |
| SIDEWAYS | 횡보장 감지 (6지표) | `backtest_v4.py:_prepare_sideways_metrics` |
| R_STOP_ATR_TIME | ATR 손절 + 시간 손절 | `backtest_v4.py:atr_mult=1.5/2.5` |
| R_CONL_FILTER_FIXED_BUY | CONL ADX+EMA 필터, $6,750 고정 | `backtest_v4.py:_passes_conl_entry_filter` |
| R_TWIN_FIXED_TP_4060 | SOXL/CONL/IRE 40/60 분할 익절 | `backtest_v4.py:fixed_tp_active` |
| R_CRASH_BUY | 급락 역매수 (-40%) | `backtest_v4.py:_process_crash_buy` |
| R_SWING_MODE | 급등 스윙 (13절) | `backtest_v4.py:_evaluate_swing_mode` |
| R_ENTRY_EARLY_GATE | 조건부 조기 진입 | `backtest_v4.py:_get_entry_start_time` |

---

## 11. v4 한계 및 개선 방향

### 11-1. 확인된 문제점

| 문제 | 상세 | 권고 |
|---|---|---|
| **swing_stage1 일관적 손실** | 2회 모두 손절, -$2,255 (전체 손실의 94%) | Phase 2에서 비활성화 검토 |
| **swing_stage2 재현성** | 2회 표본, 모두 GLD, 금 강세장 의존 | 다른 종목(SOXX/IREN)으로 발동 가능한지 검증 |
| **9시 집중 진입** | ENTRY_CUTOFF=9h로 53% 진입이 9시대 | 10~11시 성공 사례도 있으므로 범위 탐색 필요 |
| **PAIR_GAP_SELL_THRESHOLD 괴리** | 현재 config 0.9% vs 최적 6.6% | 즉시 파라미터 반영 검토 |

### 11-2. Phase 2 최적화 우선순위

1. **swing_stage1 비활성화** → MDD 개선 핵심
2. **swing_stage2 발동 조건 확대** → 재현성 검증
3. **매수 시각 최적화** → 10~11시 성공 사례 기반 탐색
4. **twin 분할매도 임계값** → `PAIR_GAP_SELL_THRESHOLD_V2` 7~9% 범위

### 11-3. v5 대비 v4 우위

| 항목 | v4 | v5 |
|---|---|---|
| 총 수익률 | **+25.49%** | -13.68% |
| CB 과도 차단 | 1,630회 | 22,766회 (과잉) |
| MDD | **9.34%** | 14.17% |
| 진단 | 균형적 방어 | 방어 과잉 → 수익 기회 차단 |

> v5의 IAU/GDXU Unix 방어모드가 오히려 수익 기회를 과도하게 차단. v4의 CB 구조가 더 균형적.

---

## 12. 파라미터 요약 (Best #388 기준)

| 파라미터 | Best | Baseline |
|---|---|---|
| `V4_PAIR_GAP_ENTRY_THRESHOLD` | 2.0% | 2.2% |
| `PAIR_GAP_SELL_THRESHOLD_V2` | 6.6% | 0.9% |
| `STOP_LOSS_PCT` | -4.25% | -3.0% |
| `STOP_LOSS_BULLISH_PCT` | -16.0% | -8.0% |
| `V4_DCA_MAX_COUNT` | 1회 | 4회 |
| `DCA_DROP_PCT` | -1.35% | -0.5% |
| `V4_CB_VIX_SPIKE_PCT` | 3.0% | 6.0% |
| `V4_CB_VIX_COOLDOWN_DAYS` | 13일 | 7일 |
| `V4_CB_GLD_COOLDOWN_DAYS` | 1일 | 3일 |
| `V4_CONL_ADX_MIN` | 10.0 | 18.0 |
| `V4_CONL_EMA_SLOPE_MIN_PCT` | +0.5% | 0.0% |
| `V4_SIDEWAYS_ATR_DECLINE_PCT` | 10.0% | 20.0% |
| `V4_SIDEWAYS_VOLUME_DECLINE_PCT` | 15.0% | 30.0% |
| `V4_SIDEWAYS_RSI_HIGH` | 65.0 | 55.0 |
| `V4_SIDEWAYS_RSI_LOW` | 35.0 | 45.0 |
| `V4_PAIR_FIXED_TP_PCT` | 7.5% | 5.0% |
| `V4_PAIR_IMMEDIATE_SELL_PCT` | 0.20 | 0.40 |
| `CONL_SELL_PROFIT_PCT` | 4.5% | 2.8% |

---

## 13. 결론

v4는 v2~v5 중 **유일하게 수익을 낸 버전**이다. 핵심 성공 요인은:

1. **서킷 브레이커 6종** — 극단적 시장 환경에서 현금 보전
2. **ATR 기반 손절** — 고정 -3% 대비 손절 횟수 대폭 감소 (124→1회)
3. **기술적 횡보장 감지** — v3 실전 차단 0건 → v4 37일(Baseline)/122일(Optuna) 차단
4. **급등 스윙 전략** — swing_stage2 2회가 전체 수익의 125% 기여
5. **수수료 절감** — $7,891(v2) → $676(v4), 91% 절감

**최적화 후 수익률 +32.44%, Sharpe 1.65, 승률 70.2%** — v3 대비 두 배 이상의 성과.

---

*생성: 2026-02-23 | 근거 데이터: `docs/reports/backtest/v4_best_trade_analysis_2026-02-19.md`, `version_comparison_table.md`, `optuna_param_comparison.md`*
