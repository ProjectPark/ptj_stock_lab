# PTJ Stock 시뮬레이션 구조도 (V1 / V2)

## 1. 전체 아키텍처

```
╔═════════════════════════════════════════════════════════════════════════╗
║                              DATA SOURCES                               ║
╠════════════════════════╦════════════════════╦═══════════════════════════╣
║  KIS API               ║  Alpaca API        ║  Polymarket Gamma API     ║
║  (실시간 시세)         ║  (1분/5분 OHLCV)   ║  (BTC/NDX/ETH 확률)       ║
║  -> Live Trading 전용  ║  -> Backtest 전용  ║  -> V2 Backtest 전용      ║
╚════════════════════════╩════════════════════╩═══════════════════════════╝
         |                      |                          |
         v                      v                          v
╔══════════════════╗  ╔════════════════════╗  ╔════════════════════════════╗
║  Live Trading    ║  ║  Backtest V1       ║  ║  Backtest V2               ║
║  (1초 루프)      ║  ║  (5분 바 기반)     ║  ║  (1분 바 + Polymarket)     ║
║  FastAPI + SSE   ║  ║  backtest.py       ║  ║  backtest_v2.py            ║
╚══════════════════╝  ╚════════════════════╝  ╚════════════════════════════╝
```


## 2. Live Trading 데이터 흐름

```
╔══════════════════╗
║  KIS API         ║
║  해외주식 시세   ║
╚════════╦═════════╝
         ║
         ▼
╔══════════════════════════════════════════════════════════════════════╗
║  PriceService (1초 루프)                                             ║
║                                                                      ║
║  ┌────────────────────┐      ┌────────────────────────────────┐      ║
║  │ fetch_all_         │ ───▶ │ calc_changes()                 │      ║
║  │ snapshots()        │      │ (현재가 vs 전일종가 등락률)    │      ║
║  └────────────────────┘      └────────────────────────────────┘      ║
║                                  │                                   ║
║                                  ▼                                   ║
║               ┌──────────────────────────────────────┐               ║
║               │ generate_all_signals()               │               ║
║               │ V1: signals.py (5개 함수)            │               ║
║               │ V2: signals_v2.py (8개 함수)         │               ║
║               └──────────────────────────────────────┘               ║
╚══════════════════════════════════╪═══════════════════════════════════╝
                             │
              ┌──────────────┼──────────────┐
              ▼                             ▼
        ╔══════════════════╗         ╔════════════════════╗
        ║  Redis           ║         ║  SSE Broadcast     ║
        ║  ┌────────────┐  ║         ║  EventSource API   ║
        ║  │ ptj:latest │  ║         ╚═════════╦══════════╝
        ║  │  (캐시)    │  ║                   ║
        ║  └────────────┘  ║                   ▼
        ║  ┌────────────┐  ║         ╔════════════════════╗
        ║  │ prices:    │  ║         ║  React Frontend    ║
        ║  │ updates    │  ║         ║  (TradingView)     ║
        ║  │  (pub/sub) │  ║         ╚════════════════════╝
        ║  └────────────┘  ║
        ╚══════════════════╝
```


## 3. 시그널 비교표 (V1 vs V2)

```
╔════════════════════╦════════════════════════════╦══════════════════════════════╦════════════════════════════╗
║ 시그널             ║ V1                         ║ V2                           ║ 핵심 차이                  ║
╠════════════════════╬════════════════════════════╬══════════════════════════════╬════════════════════════════╣
║ Gold               ║ GLD >0% -> 매수 차단       ║ 동일 + allow_extra_buy       ║ V2는 추가매수 허용 분리    ║
╠════════════════════╬════════════════════════════╬══════════════════════════════╬════════════════════════════╣
║ Twin Pairs         ║ gap <=0.3% -> SELL         ║ gap <=0.9% AND follow>0%     ║ V2는 수익조건 추가,        ║
║                    ║                            ║ -> SELL                      ║ 임계값 0.3->0.9 상향       ║
╠════════════════════╬════════════════════════════╬══════════════════════════════╬════════════════════════════╣
║ Conditional COIN   ║ 트리거 전부 >0% -> BUY     ║ 트리거 각각 >=+3.0%          ║ V2는 진입기준 대폭 강화    ║
╠════════════════════╬════════════════════════════╬══════════════════════════════╬════════════════════════════╣
║ Conditional CONL   ║ 없음                       ║ 트리거 >=+3.0%               ║ V2 신규: 레버리지 추가     ║
║                    ║                            ║ -> CONL 매수                 ║                            ║
╠════════════════════╬════════════════════════════╬══════════════════════════════╬════════════════════════════╣
║ Stop Loss          ║ 고정 -3.0%                 ║ Bullish -8.0%                ║ V2는 모드별 동적 조절      ║
║                    ║                            ║ / 기타 -3.0%                 ║                            ║
╠════════════════════╬════════════════════════════╬══════════════════════════════╬════════════════════════════╣
║ Bearish            ║ HIMZ, BRKU, BABX 3종       ║ BRKU 단일 (10% 비중)         ║ V2는 방어주 단순화         ║
╚════════════════════╩════════════════════════════╩══════════════════════════════╩════════════════════════════╝
```


## 4. V2 시장 모드 결정 (Polymarket 기반)

```
╔══════════════════════════════════════════════════════════════╗
║                    Polymarket 확률 데이터                    ║
║  polymarket/history/{YYYY-MM-DD}_{fidelity}m.json            ║
║                                                              ║
║  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐  ║
║  │ btc_up_down    │  │ ndx_up_down    │  │ eth_above      │  ║
║  │ (BTC 상승확률) │  │ (NDX 상승확률) │  │ (ETH 상승확률) │  ║
║  └────────────────┘  └────────────────┘  └────────────────┘  ║
╚══════════╪══════════════════╪══════════════════╪═════════════╝
           │                  │                  │
           └──────────────────┼──────────────────┘
                              ▼
               ╔══════════════════════════════╗
               ║ determine_market_mode()      ║
               ╚══════════════╦═══════════════╝
                              ║
               ┌──────────────╬──────────────┐
               ▼              ▼              ▼
    ╔══════════════════╗ ╔══════════════════╗ ╔══════════════════════╗
    ║    BULLISH       ║ ║    NORMAL        ║ ║    BEARISH           ║
    ║                  ║ ║                  ║ ║                      ║
    ║  BTC up >= 70%   ║ ║  그 외           ║ ║  BTC+NDX+ETH         ║
    ║                  ║ ║                  ║ ║  모두 <= 20%         ║
    ╠══════════════════╣ ╠══════════════════╣ ╠══════════════════════╣
    ║  SL: -8.0%       ║ ║  SL: -3.0%       ║ ║  SL: -3.0%           ║
    ║  익일 캐리 O     ║ ║  익일 캐리 X     ║ ║  COIN 익절: 0.3%     ║
    ║  공격적 매수     ║ ║  기본 운영       ║ ║  BRKU 10% 편입       ║
    ╚══════════════════╝ ╚══════════════════╝ ╚══════════════════════╝
```


## 5. 종목 구성 비교

```
╔═══════════════════════════════════╦═════════════════════════════════════╗
║            V1 (15종목)            ║             V2 (14종목)             ║
╠═══════════════════════════════════╬═════════════════════════════════════╣
║                                   ║                                     ║
║  Gold:  GLD                       ║  Gold:  GLD                         ║
║                                   ║                                     ║
║  Twin Pairs:                      ║  Twin Pairs:                        ║
║   코인: BITU <-> MSTU             ║   코인: BITU <-> [MSTU, IRE]  *멀티*║
║   은행: ROBN <-> CONL             ║   은행: ROBN <-> CONL               ║
║   반도체: NVDL <-> AMDL           ║   반도체: NVDL <-> SOXL  *변경*     ║
║                                   ║                                     ║
║  Conditional:                     ║  Conditional:                       ║
║   트리거: ETHU, XXRP, SOLT        ║   트리거: ETHU, XXRP, SOLT          ║
║   대상: COIN                      ║   대상: COIN + CONL  *추가*         ║
║                                   ║                                     ║
║  Bearish:                         ║  Bearish:                           ║
║   HIMX, BRKU, BABX                ║   BRKU  *단순화*                    ║
║                                   ║                                     ║
║  Index: SPY, QQQ                  ║  Index: SPY, QQQ                    ║
║                                   ║                                     ║
╚═══════════════════════════════════╩═════════════════════════════════════╝
```


## 6. 백테스트 엔진 흐름

### V1 -- 5분 바 백테스트 (backtest.py)

```
╔══════════════════════════════════╗
║  data/backtest_5min.parquet      ║
║  Alpaca 5분 OHLCV                ║
║  기간: 2025-02-18 ~ 2026-02-17   ║
╚════════════════╦═════════════════╝
                 ║
                 ▼
╔══════════════════════════════════════════════════╗
║  V1 시뮬레이션 루프 (날짜별)                     ║
║                                                  ║
║  ┌──────────────────────────────────────────────┐║
║  │  09:30~10:00  첫 30분: Gold 체크             │║
║  │  GLD 등락률 확인 -> 매수 차단 여부 결정      │║
║  └──────────────────────────────────────────────┘║
║                        │                         ║
║                        ▼                         ║
║  ┌──────────────────────────────────────────────┐║
║  │  5분마다 반복:                               │║
║  │  +- 등락률 계산 (현재가 vs 당일 시가)        │║
║  │  +- Twin gap = lead% - follow%               │║
║  │  +- gap >= 1.5% -> ENTRY (follow 매수)       │║
║  │  +- gap <= 0.3% -> SELL  (follow 매도)       │║
║  │  +- 트리거 전부 >0% -> COIN 매수             │║
║  │  +- 보유종목 <= -3.0% -> 손절                │║
║  └──────────────────────────────────────────────┘║
║                        │                         ║
║                        ▼                         ║
║  ┌──────────────────────────────────────────────┐║
║  │  16:00 장 마감: 전 포지션 청산               │║
║  └──────────────────────────────────────────────┘║
║                                                  ║
║  비중: Twin 20% / Conditional 20% / Bear 10%     ║
╚═════════════════════════╦════════════════════════╝
                          ▼
              ╔════════════════════════╗
              ║  Trade 기록            ║
              ║  +- 수익률             ║
              ║  +- 승률               ║
              ║  +- 수수료 차감        ║
              ╚════════════════════════╝
```

### V2 -- 1분 바 백테스트 (backtest_v2.py)

```
╔══════════════════════════╗   ╔══════════════════════════════╗
║  data/backtest_1min_v2   ║   ║  polymarket/history/*.json   ║
║  .parquet                ║   ║  일별 BTC/NDX/ETH 확률       ║
║  Alpaca 1분 OHLCV        ║   ║                              ║
╚════════════╦═════════════╝   ╚═══════════════╦══════════════╝
             ╚════════════════════════════════════╝
                              │
                              ▼
╔════════════════════════════════════════════════════════════════════╗
║  BacktestEngineV2                                                  ║
║  초기자본: 20,000,000 KRW                                          ║
║                                                                    ║
║  ┌──────────────────────────────────────────────────────────────┐  ║
║  │  일봉 시작:                                                  │  ║
║  │  Polymarket 확률 로딩 -> determine_market_mode()             │  ║
║  │  -> BULLISH / NORMAL / BEARISH 결정                          │  ║
║  └──────────────────────────────────────────────────────────────┘  ║
║                                 │                                  ║
║                                 ▼                                  ║
║  ┌──────────────────────────────────────────────────────────────┐  ║
║  │  1분마다 반복:                                               │  ║
║  │                                                              │  ║
║  │  (1) Gold Signal                                             │  ║
║  │      GLD >0% -> warning, 추가매수 차단                       │  ║
║  │                                                              │  ║
║  │  (2) Twin Pairs Signal                                       │  ║
║  │      gap >= 1.5% -> follow 진입 (DCA 분할매수)               │  ║
║  │      gap <= 0.9% AND follow >0% -> 분할매도                  │  ║
║  │                                                              │  ║
║  │  (3) Conditional COIN                                        │  ║
║  │      ETHU,XXRP,SOLT 각각 >=+3.0% -> COIN 매수                │  ║
║  │      익절: Normal 3.0% / Bearish 0.3%                        │  ║
║  │                                                              │  ║
║  │  (4) Conditional CONL  (V2 신규)                             │  ║
║  │      ETHU,XXRP,SOLT 각각 >=+3.0% -> CONL 매수                │  ║
║  │      익절: 2.8% 또는 트리거 평균 <1.0% 시 매도               │  ║
║  │                                                              │  ║
║  │  (5) Stop Loss (모드별)                                      │  ║
║  │      Bullish: -8.0% / Normal+Bearish: -3.0%                  │  ║
║  │                                                              │  ║
║  │  (6) Bearish Defense                                         │  ║
║  │      Bearish 모드 -> BRKU 10% 비중 편입                      │  ║
║  └──────────────────────────────────────────────────────────────┘  ║
║                                 │                                  ║
║                                 ▼                                  ║
║  ┌──────────────────────────────────────────────────────────────┐  ║
║  │  Bullish 모드: 익일 캐리 (포지션 유지)                       │  ║
║  │  그 외 모드:   16:00 장 마감 시 청산                         │  ║
║  └──────────────────────────────────────────────────────────────┘  ║
╚══════════════════════════════════╦═════════════════════════════════╝
                                   ▼
                     ╔════════════════════════════╗
                     ║  결과 리포트               ║
                     ║  +- 총 수익률 (%)          ║
                     ║  +- MDD (최대 낙폭)        ║
                     ║  +- Sharpe Ratio           ║
                     ║  +- 트레이드 로그 (CSV)    ║
                     ║  +- 에쿼티 커브            ║
                     ╚════════════════════════════╝
```


## 7. V2 포지션 관리 구조

```
╔═════════════════════════════════════════════════════════════════╗
║  Position (포지션 데이터 모델)                                  ║
║                                                                 ║
║  ticker: "MSTU"       signal_type: "twin_pairs"                 ║
║  avg_price: $12.50    total_invested_krw: 4,000,000             ║
║                                                                 ║
║  ┌───────────────────────────────────────────────────────────┐  ║
║  │  DCA 분할매수 (최대 8회: 초기 + 추가 7회)                 │  ║
║  │                                                           │  ║
║  │  ╔══════╦══════╦══════╦══════╦══════╦══════╦══════╦══════╗│  ║
║  │  ║ #0   ║ #1   ║ #2   ║ #3   ║ #4   ║ #5   ║ #6   ║ #7   ║│  ║
║  │  ║ 초기 ║ 추가 ║ 추가 ║ 추가 ║ 추가 ║ 추가 ║ 추가 ║ 추가 ║│  ║
║  │  ║$13.0 ║$12.8 ║$12.5 ║$12.2 ║      ║      ║      ║      ║│  ║
║  │  ╚══════╩══════╩══════╩══════╩══════╩══════╩══════╩══════╝│  ║
║  │  -> 하락시 추가매수로 평균단가 낮춤                       │  ║
║  └───────────────────────────────────────────────────────────┘  ║
║                                                                 ║
║  ┌───────────────────────────────────────────────────────────┐  ║
║  │  Staged Sell 분할매도 (5단계)                             │  ║
║  │                                                           │  ║
║  │  ╔══════════╦══════════╦══════════╦══════════╦══════════╗ │  ║
║  │  ║  1/5     ║  2/5     ║  3/5     ║  4/5     ║  5/5     ║ │  ║
║  │  ║  20%     ║  20%     ║  20%     ║  20%     ║  20%     ║ │  ║
║  │  ║  매도완  ║  매도완  ║  대기중  ║          ║          ║ │  ║
║  │  ╚══════════╩══════════╩══════════╩══════════╩══════════╝ │  ║
║  │  -> 익절 시그널 발생 후 5번에 나눠 매도                   │  ║
║  └───────────────────────────────────────────────────────────┘  ║
║                                                                 ║
║  carry: true (Bullish 모드 -> 익일까지 보유)                    ║
╚═════════════════════════════════════════════════════════════════╝
```


## 8. 수수료 구조 (backtest_common.py)

```
╔═══════════════════════════════════════════════════════════════╗
║  KIS 해외주식 수수료 (한국투자증권)                           ║
╠═══════════════════════════════════════════════════════════════╣
║                                                               ║
║  ┌───────────────────────────────────────────────────────┐    ║
║  │ 매수                                                  │    ║
║  │   위탁수수료    0.25%                                 │    ║
║  │   환전스프레드  0.10%                                 │    ║
║  │   ─────────────────────                               │    ║
║  │   매수 합계     0.35%                                 │    ║
║  └───────────────────────────────────────────────────────┘    ║
║                                                               ║
║  ┌───────────────────────────────────────────────────────┐    ║
║  │ 매도                                                  │    ║
║  │   위탁수수료    0.25%                                 │    ║
║  │   SEC Fee      0.00278%                               │    ║
║  │   환전스프레드  0.10%                                 │    ║
║  │   ─────────────────────                               │    ║
║  │   매도 합계     0.35278%                              │    ║
║  └───────────────────────────────────────────────────────┘    ║
║                                                               ║
║  ═══════════════════════════════════════                      ║
║  왕복 합계: 약 0.703%                                         ║
║  ═══════════════════════════════════════                      ║
╚═══════════════════════════════════════════════════════════════╝
```


## 9. 파일 매핑

```
╔═══════════════════════════════╦══════════════════════════════════════════╦════════╗
║ 파일                          ║ 역할                                     ║ 버전   ║
╠═══════════════════════════════╬══════════════════════════════════════════╬════════╣
║ backend/app/core/signals.py   ║ 시그널 생성 함수 5개                     ║ V1     ║
╠═══════════════════════════════╬══════════════════════════════════════════╬════════╣
║ signals_v2.py                 ║ 시그널 생성 함수 8개 + 시장 모드         ║ V2     ║
╠═══════════════════════════════╬══════════════════════════════════════════╬════════╣
║ backend/app/config.py         ║ V1/V2 프리셋 + Settings                  ║ 공통   ║
╠═══════════════════════════════╬══════════════════════════════════════════╬════════╣
║ backtest_common.py            ║ 수수료, MDD, Sharpe, 데이터 로딩         ║ 공통   ║
╠═══════════════════════════════╬══════════════════════════════════════════╬════════╣
║ backtest.py                   ║ 5분 백테스트 엔진                        ║ V1     ║
╠═══════════════════════════════╬══════════════════════════════════════════╬════════╣
║ backtest_v2.py                ║ 1분 백테스트 엔진 (DCA+분할매도)         ║ V2     ║
╠═══════════════════════════════╬══════════════════════════════════════════╬════════╣
║ backtest_twin_gap.py          ║ 쌍둥이 페어 단독 시뮬레이션              ║ V1     ║
╠═══════════════════════════════╬══════════════════════════════════════════╬════════╣
║ backtest_5min_signals.py      ║ 시그널 타임라인 생성기                   ║ V1     ║
╠═══════════════════════════════╬══════════════════════════════════════════╬════════╣
║ optimize_stoploss.py          ║ 손절 파라미터 최적화                     ║ 공통   ║
╠═══════════════════════════════╬══════════════════════════════════════════╬════════╣
║ optimize_with_fees.py         ║ 수수료 포함 최적화                       ║ 공통   ║
╚═══════════════════════════════╩══════════════════════════════════════════╩════════╝
```


## 10. 핵심 설계 철학

```
╔═══════════════════════════════════════════════════════════════╗
║  V1: 정적 규칙 기반                                           ║
╠═══════════════════════════════════════════════════════════════╣
║                                                               ║
║  * 모든 장세에 동일한 임계값 적용                             ║
║  * 단순하고 일관된 규칙 (검증 용이)                           ║
║  * 단일 팔로우, 단일 조건부 대상                              ║
║  * 수수료 미반영 가능                                         ║
║                                                               ║
╚═══════════════════════════════════════════════════════════════╝

╔═══════════════════════════════════════════════════════════════╗
║  V2: 동적 규칙 기반 (시장 적응형)                             ║
╠═══════════════════════════════════════════════════════════════╣
║                                                               ║
║  * Polymarket 감성 데이터로 장세 판단                         ║
║  * 장세별 파라미터 자동 조절 (SL, 익절, 캐리)                 ║
║  * DCA 분할매수 (최대 8회) + 5단계 분할매도                   ║
║  * 멀티 팔로우, 듀얼 조건부 대상 (COIN + CONL)                ║
║  * KIS 수수료 완전 반영 (왕복 0.703%)                         ║
║                                                               ║
╚═══════════════════════════════════════════════════════════════╝
```
