# 전략 노트 — 태준 매매 전략 전체 리뷰 (taejun_attach_pattern)

> 작성일: 2026-02-20
> 출처: kakaotalk_trading_notes_2026-02-19.csv (박태준)
> 엔진: strategies/taejun_attach_pattern/
> 전일 대비 변경: SETH/BAC 목표수익률 정정, 수수료 기준 0.74%, 리츠 과열 조절 모드 신설, 마스터 플랜 M1~M5 신설, 수익금 분배 규칙 신설
> ⚠️ 미확인 모호사항: P-1~P-4 (섹션 2-A 참조) — 태준님 확인 후 반영 예정

---

## 요약

박태준 매매 전략 11개를 `taejun_attach_pattern` 엔진으로 구현 완료.
본 문서는 전략별 상세 정리, 마스터 플랜(M1~M5), 수익금 분배 규칙, Critical/Algorithm 이슈를 기록한다.

---

## 0. 마스터 플랜 (M1~M5)

모든 전략/모드에 절대적으로 적용되는 공통 규칙.

| 규칙 | 내용 |
|------|------|
| **M1** | **절대 시장가 매수/매도 금지** — 이머전시/공격/레버리지 코인 공격/방어/조심 모드 포함 전 상황 |
| **M2** | 조건이 달성된 날짜/시간에 **즉시 행동** |
| **M3** | 공휴일·휴장일 제외, **17:30~06:00 KST, 월~금** 조건 달성시 매수/매도 실행 |
| **M4** | (추후 추가 예정) |
| **M5** | 매수/매도 완료시 조건 부합 개수를 **각 1개씩 차감(초기화)** |

### M3 — 당일 조건 부합 개수별 진입 비율

| 당일 조건 부합 개수 | 초기 진입 비율 |
|--------------------|--------------|
| 1개 | 50% |
| 2개 | 40% |
| 3개 | 33% |
| 4개 | 22% |
| 5개 이상 | 13% |

> **주의:** 저가매수(G) 전략의 기존 C-3 이슈(종목별 entry_size)는 이 M3 규칙으로 대체된다.

---

## 0-A. 수익금 분배 규칙

매도 후 수익금 처리:

| 규칙 | 내용 |
|------|------|
| 주기 | **1일당** 각 1주씩 매수 |
| 대상 종목 | SOXL, ROBN, GLD, CONL |
| 방식 | 수익금 발생시 4종목 순서대로 1주씩 구매 |

---

## 1. 전략 일람 (11개)

---

## 2-A. 미확인 모호사항 (태준님 확인 필요)

> 아래 항목은 2026-02-20 추가 내용 중 해석이 2가지 이상 가능한 부분입니다.
> 확인 전까지 코드 반영 보류.

---

### P-1. 수익금 분배 — 수량 부족시 처리 방식

**내용:** 1일당 SOXL, ROBN, GLD, CONL 각 1주씩 매수

**모호한 점:**

| 질문 | 선택지 |
|------|--------|
| 4종목 구매 순서? | A. 동시 구매 / B. SOXL → ROBN → GLD → CONL 순서대로 |
| 수익금이 4주 모두 살 돈이 부족할 때? | A. 앞 종목부터 우선 구매 / B. 그날은 전부 미실행 |

---

### P-2. "리츠과열시 제외항 0.5% 낮춤" — 제외 범위

**내용:** 모든 목표수익률 리츠과열시 제외항 0.5% 낮춘다.

**모호한 점:**

| 해석 | 설명 |
|------|------|
| **해석 A** | 리츠 과열 공격 조절 모드에서 이미 50% 적용된 종목(SOXX, HOOD, GLD)을 제외하고, 나머지 전략 전체 목표 수익률 −0.5% |
| **해석 B** | 리츠 리스크(I) 전략 자체를 제외하고, 나머지 전체 전략 목표 수익률 −0.5% |

---

### P-3. M5 "각각 1개씩 차감" — 차감 기준

**내용:** 조건 달성 후 매수매도가 끝나면 조건 부합 개수 각각 1개씩 차감

**모호한 점:**

| 질문 | 선택지 |
|------|--------|
| 차감 시점? | A. 매수 완료시 1개 차감 / B. 매수+매도 세트 완료시 1개 차감 |
| "각각"의 범위? | A. 전략별로 따로 카운트 / B. 당일 전체 공통 카운트 1 차감 |

---

### P-4. M3 진입 비율 vs TSLL 소액 한도 — 우선순위

**내용:** TSLL은 "200만원 이하 소액" 별도 한도 + M3 비율(50%/40%/33%...) 동시 적용

**모호한 점:**

| 질문 | 선택지 |
|------|--------|
| 둘이 충돌할 때 우선순위? | A. M3 비율 우선 (200만원 한도는 상한선으로만 적용) / B. 200만원 한도 우선 (M3 비율은 그 안에서 적용) |

---

| # | 전략명 | 코드 파일 | 유형 | 종목 | 목표 수익 |
|---|--------|----------|------|------|----------|
| A | 잽모드 SOXL | `jab_soxl.py` | 프리마켓 단타 | SOXL | +0.9% |
| B | 잽모드 BITU | `jab_bitu.py` | 프리마켓 단타 | BITU | +0.9% |
| C | 잽모드 TSLL | `jab_tsll.py` | 소액 단타 | TSLL | +1.0% |
| D | 숏 잽모드 SETH | `jab_seth.py` | 숏 단타 | SETH | **+0.8%** *(정정)* |
| E | VIX → GDXU | `vix_gold.py` | 이벤트 드리븐 | GDXU → IAU | +10% |
| F | S&P500 편입 | `sp500_entry.py` | 이벤트 드리븐 | 편입 기업 | +1.5% |
| G | 저가매수 | `bargain_buy.py` | 스윙/장기 | 11종목 | 종목별 상이 |
| H | 숏포지션 전환 | `short_macro.py` | 매크로 | GDXU | +90% |
| I | 리츠 리스크 | `reit_risk.py` | 리스크 관리 | - | - |
| J | 섹터 로테이션 | `sector_rotate.py` | 순환 배분 | SOXL/ROBN/GDXU | - |
| K | 조건부 은행주 | `bank_conditional.py` | 역전 매매 | BAC | **+0.8%** *(정정)* |

---

## 2. 전략별 상세

### A. 잽모드 SOXL (Jab-SOXL)

> 반도체 개별주 모두 상승인데 SOXX/SOXL만 마이너스 → 레버리지 괴리 역전

| 항목 | 내용 |
|------|------|
| 진입 시간 | 17:30 KST ~ 장마감 |
| 매수 대상 | SOXL |
| 매수 비중 | M3 비율 기준 |
| 목표 수익률 | +0.9% (수수료 제외 net) |
| 매도 방식 | 전액 매도 |

**진입 조건 (16개 ALL 충족):**

| # | 종목/지표 | 조건 | 비고 |
|---|----------|------|------|
| 1 | Polymarket NASDAQ | >= 51% | |
| 2 | GLD | >= +0.1% | |
| 3 | QQQ | >= +0.3% | |
| 4 | SOXX | <= -0.2% | 지수는 마이너스 |
| 5 | **SOXL** | <= -0.6% | 매수 대상, 과매도 |
| 6 | NVDA | >= +0.9% | |
| 7 | AMD | >= +0.9% | |
| 8 | SMCI | >= +1.0% | |
| 9 | KLA | >= +0.8% | |
| 10 | AMAT | >= +0.8% | |
| 11 | AVGO | >= +0.55% | |
| 12 | MPWR | >= +0.55% | |
| 13 | TXN | >= +0.66% | |
| 14 | ASML | >= +1.0% | |
| 15 | LRCX | >= +0.8% | |
| 16 | MU | >= +0.55% | |

---

### B. 잽모드 BITU (Jab-BITU)

> BTC 생태계 상승 + BITU 과매도 → 역전

| 항목 | 내용 |
|------|------|
| 진입 시간 | 17:30 KST ~ 장마감 |
| 매수 대상 | BITU |
| 매수 비중 | M3 비율 기준 |
| 목표 수익률 | +0.9% (수수료 제외 net) |
| 매도 방식 | 전액 매도 |

**진입 조건 (ALL 충족):**

| # | 종목/지표 | 조건 |
|---|----------|------|
| 1 | Polymarket BTC | >= 63% |
| 2 | GLD | >= +0.1% |
| 3 | **BITU** | <= -0.4% |
| 4 | BTC (스팟) | >= +0.9% |
| 5 | ETH (스팟) | >= +0.9% |
| 6 | SOL (스팟) | >= +2.0% |
| 7 | XRP (스팟) | >= +5.0% |

---

### C. 잽모드 TSLL (Jab-TSLL)

> TSLA 상승 + TSLL 과매도 → 소액 역전

| 항목 | 내용 |
|------|------|
| 진입 시간 | 17:30 KST ~ 장마감 |
| 매수 대상 | TSLL |
| 매수 비중 | **200만원 이하 소액** |
| 목표 수익률 | +1.0% (수수료 제외 net) |
| 매도 방식 | 전액 매도 → 현금 보유 |

**진입 조건 (ALL 충족):**

| # | 종목/지표 | 조건 |
|---|----------|------|
| 1 | Polymarket NASDAQ | >= 63% |
| 2 | GLD | <= +0.3% |
| 3 | **TSLL** | <= -0.8% |
| 4 | TSLA | >= +0.5% |
| 5 | QQQ | >= +0.7% |

---

### D. 숏 잽모드 SETH (Jab-SETH)

> ETH 하락 기대 높을 때 숏 ETF

| 항목 | 내용 |
|------|------|
| 매수 대상 | SETH |
| 목표 수익률 | **+0.8%** (수수료 제외 net) *(정정: 0.5% → 0.8%)* |
| 매도 방식 | 전액 매도 |

**진입 조건:**

| # | 종목/지표 | 조건 |
|---|----------|------|
| 1 | Polymarket ETH 하락 기대 | >= 12% |
| 2 | GLD | >= +0.01% |
| 3 | SETH | >= 0.00% (양전) |

---

### E. VIX → GDXU (VIX-Gold)

> 공포 지수 급등 → 금광 3x 매수

| 항목 | 내용 |
|------|------|
| 매수 대상 | GDXU (금광 3x) |
| 매수 비중 | M3 비율 기준 |
| 목표 수익률 | +10% |
| 매도 후 | 수익 전액 → IAU 매수 (정정: GLD → IAU) |

**진입 조건:**

| # | 지표 | 조건 |
|---|------|------|
| 1 | VIX 일간 변동 | >= +10% |
| 2 | Polymarket 하락 기대 | >= 30% |

---

### F. S&P500 편입 기업 (SP500-Entry)

> 신규 편입 다음 날 매수

| 항목 | 내용 |
|------|------|
| 매수 대상 | 편입 기업 (흑자 한정) |
| 매수 비중 | M3 비율 기준 |
| 목표 수익률 | +1.5% (수수료 제외 net) |
| 금지 조건 | GLD 상승시, Polymarket NASDAQ < 51% |

---

### G. 저가매수 (Bargain-Buy)

> 3년 최고가 대비 폭락시 진입

| 종목 | 하락 진입 | 추가매수 조건 | 목표 | 분할매도 | 수익금 행선지 | 비고 |
|------|----------|-------------|------|---------|-------------|------|
| CONL | -80% | -3% 추가 하락 | +188% | 전액 | CONL 30일 분할 | 스윙 |
| SOXL | -90.5% | -5% | +320% | 6회 | SOXL 30일 분할 | |
| AMDL | -89% | -5% | +40% | 6회 | SOXL 30일 분할 | |
| NVDL | -73% | -5% | +200% | 6회 | SOXL 30일 분할 | |
| ROBN | -83% | -3% | +200% | 6회 | CONL 30일 분할 | |
| ETHU | -95% | -10% 추가시 10% 더 | +20% | 6회 | ROBN 100일 분할 | |
| BRKU | -32% | -3% | +0.5% | 전액 | 현금화 | 단기 |
| NFXL | -26% | -20% | +0.9% | 전액 | 현금화 | 단기 |
| SNXX | -46% | -10% | +3% | 전액 | 현금화 | 단기 |
| OKLL | -55% | -12% | +3% | 전액 | 현금화 | 단기 |
| PLTU | -44% | -10% | +10% | 전액 | 현금화 | 20일 기한 |

> **초기 진입 비율**: M3 규칙 적용 (당일 조건 부합 개수에 따라 동적 결정)

**저가매수 금지 조건:** 유상증자 / 투자자 기대치 낮음 / 3일 전후 거래량 감소 / 금 하락 / Poly 상승 49% 이하

---

### H. 숏포지션 전환 (Short-Macro)

> 나스닥/S&P500 ATH → 전면 숏 전환

| 항목 | 내용 |
|------|------|
| 진입 조건 | 나스닥/S&P500 역대 최고가 |
| 행동 | GDXU/IAU/GLD/현금 제외 모든 롱 매도 |
| GDXU | 100% 구축, +90% 매도 |
| 매도 후 | 수익 전액 → IAU 매수 |
| 청산 | 전액 매도 (정정: 분할매도 → 전액매도) |

---

### I. 리츠 리스크 (REIT-Risk)

> 리츠 과열 → 레버리지 90일 금지 + **공격 조절 모드 발동**

#### I-1. 기본 조건 및 행동

| 조건 | 기준 |
|------|------|
| 리츠 7일 연속 상승 | SK리츠, TIGER리츠, 롯데리츠 평균 +0.1% |
| 탐욕지수 | >= 75 |
| 행동 | GDXU 제외 레버리지 매매 90일 중단 |

#### I-2. 리츠 과열 공격 조절 모드 (신설 2026-02-20)

리츠 과열 트리거 발동시, 공격 전략의 매수 대상 종목을 비레버리지로 교체한다:

| 원래 종목 | 교체 종목 |
|----------|---------|
| SOXL | SOXX |
| ROBN | HOOD |
| GDXU | GLD |

**목표 수익률 조정 (리츠 과열시):**

| 적용 범위 | 조정 내용 |
|----------|---------|
| 공격 조절 모드 종목 (SOXX, HOOD, GLD) | 기존 목표 수익률 × **50%** 로 낮춤 |
| 리츠 과열 제외 모든 전략 | 목표 수익률 **−0.5%** 감소 |

---

### J. 섹터 로테이션 (Sector-Rotate)

> 4대 섹터 수익률 비교 → 다음 섹터 정기 매수

| 1위 섹터 | 매수 대상 | 주기 |
|---------|----------|------|
| 비트코인 | SOXL 1주 | 3일 1회 |
| 반도체 | ROBN | 7일 1회 |
| 은행 | GDXU | 14일 1회 |

---

### K. 조건부 은행주 (Bank-Conditional)

> 대형은행 전부 상승 + BAC만 하락 → 역전 기대

| 항목 | 내용 |
|------|------|
| 감시 종목 | JPM, HSBC, WFC, RBC, C (모두 양전) |
| 매수 대상 | BAC (마이너스) |
| 매수 금액 | 300만원 |
| 목표 | **+0.8%** (수수료 포함) *(정정: 0.5% → 0.8%)* |
| 매도 후 | 현금화 |

---

## 3. 정정 사항 반영 이력

| 날짜 | 원본 | 정정 | 출처 |
|------|------|------|------|
| 2026.2.18 18:57 | GDXU 매도 후 GLD 매수 | **IAU** 매수 | 카톡 |
| 2026.2.18 19:56 | 부동산 선행지수 하락시 분할매도 | **전액 매도** (분할 아님) | 카톡 |
| 2026.2.18 22:10 | PLTU 하락 43% 진입 | **44%** 진입 | 정리본 |
| 2026.2.18 | BRKU 하락 26% 진입 | **32%** 진입 | 초기 26% → 30% → 최종 32% |
| **2026.2.20** | SETH 목표 수익률 0.5% | **0.8%** | 오늘 정정 |
| **2026.2.20** | 은행(BAC) 목표 수익률 0.5% | **0.8%** | 오늘 정정 |
| **2026.2.20** | 왕복 수수료 0.703% | **0.74%** | 오늘 정정 |

---

## 4. Critical 이슈 (반드시 수정 필요)

### C-1. 수수료 미반영 목표 판정 ← 기준 0.74%로 정정

**현상:** 모든 전략의 `check_exit`이 gross pnl%로 목표를 판정한다. 실제 기준은 **0.74% (왕복)**.

**정정된 수수료 계산표:**

| 전략 | 목표 (net) | 왕복 수수료 | 필요 세전 | 현재 코드 | 차이 |
|------|-----------|-----------|----------|----------|------|
| jab_soxl | 0.9% | 0.74% | **1.64%** | 0.9% | -0.74% |
| jab_bitu | 0.9% | 0.74% | **1.64%** | 0.9% | -0.74% |
| jab_tsll | 1.0% | 0.74% | **1.74%** | 1.0% | -0.74% |
| jab_seth | **0.8%** | 0.74% | **1.54%** | 0.5% | 기준 자체 오류 |
| sp500_entry | 1.5% | 0.74% | **2.24%** | 1.5% | -0.74% |
| bank_conditional | **0.8%** (net) | 0.74% | **0.8%** | 0.5% | 기준 자체 오류 |

**해결:** `FeeCalculator.is_target_met(entry_price, current_price, target_net_pct)` 사용, 수수료 기준 0.74%

---

### C-2. 시장가 매수/매도 전면 금지 (M1 확장)

**현상:** `execute_buy`에서 `price = prices.get(ticker, 0)` 현재 호가로 즉시 체결 → 사실상 시장가

**대상:**
- 최초 매수 (`avg_price = price`)
- 추가매수 (`net_for_shares` + `avg_price` 혼용)
- 매도 (`price = prices.get(ticker, 0)`)

**M1 규칙:** 모든 매수/매도는 지정가. 이머전시/공격/방어/조심 모드 예외 없음.

**해결:** 지정가 주문 큐 + 체결 시뮬레이션 레이어 추가 필요

---

### C-3. 초기 진입 비율 → 마스터 플랜 M3으로 이전

기존 `bargain_buy.py:177`의 `size=0.5` 하드코딩 및 종목별 entry_size 이슈는 **M3 규칙으로 대체**.

당일 조건 부합 개수 카운팅 → Orchestrator 레벨에서 동적 size 결정.

---

## 5. Warning 이슈

| # | 내용 | 파일 | 메모 |
|---|------|------|------|
| W-1 | signal.size > 1.0 방어 없음 → 음수 포지션 | portfolio.py | min() 클램프 필요 |
| W-3 | 복수 저가매수 조건 충족시 첫 종목만 반환 | bargain_buy.py | 리스트 반환 or 우선순위 |
| W-4 | `_last_buy_dates`, `_ban_until` 재시작시 초기화 | sector_rotate, reit_risk | 영속 저장 필요 (실서빙시) |
| W-5 | `datetime.now()` 백테스트 불일치 | reit_risk.py:35 | market.time 사용 |
| W-6 | BUY 시그널에 ticker="" 반환 | sp500_entry.py | SKIP 또는 metadata |
| W-7 | jab_seth 시간 조건(17:30) 누락 | jab_seth.py | 다른 잽모드와 불일치 |
| W-8 | registry name="" 방어 없음 | registry.py | assert 추가 |
| W-9 | MarketData 입력 검증 없음 | base.py | __post_init__ 추가 |

*(Warning 이슈 상세는 별도 업데이트 예정)*

---

## 6. 알고리즘 이슈 — 코드 분석 기반 디테일

아래는 실제 코드를 분석해서 발견된 구현 이슈입니다. 코드 위치를 명시합니다.

---

### A-1. `reit_risk.py:35` — `datetime.now()` 백테스트 불일치

```python
# 현재 코드 (잘못됨)
return datetime.now() < self._ban_until

# 올바른 코드
return market.time < self._ban_until  # market.time은 백테스트 시뮬레이션 시각
```

**영향:** 백테스트시 `is_ban_active`가 항상 False 반환 → 리츠 금지 90일이 무효화됨.
`generate_signal`도 `market.time`을 받으므로 `is_ban_active(market_time)` 형태로 수정 필요.

---

### A-2. `portfolio.py:314~316` — 추가매수 평균가 단위 혼용 (C-2)

```python
# 현재 코드 (잘못됨)
total_cost = existing.avg_price * existing.qty + net_for_shares  # net_for_shares = 수수료 차감
total_qty = existing.qty + qty
existing.avg_price = total_cost / total_qty

# 최초 매수 (portfolio.py:320)
avg_price=price,  # 시장가 (수수료 미차감)
```

**영향:** 최초 매수는 시장가(price), 추가매수는 수수료 차감 후 금액(net_for_shares) → 단위 혼용으로 avg_price 부정확.

**해결:** 두 경우 모두 시장가(price) 기준으로 통일.
```python
# 수정안
total_cost = existing.avg_price * existing.qty + price * qty  # 둘 다 시장가 기준
existing.avg_price = total_cost / total_qty
```

---

### A-3. `portfolio.py:273~275` — M1 위반 (시장가 즉시 체결)

```python
# 현재 코드 — 사실상 시장가
price = prices.get(ticker, 0)
if price <= 0:
    return None
```

**영향:** M1 규칙 "절대 시장가 금지" 위반. 현재 스냅샷 가격으로 즉시 체결.

**해결 방향:**
- `OrderBook` 또는 `LimitOrderQueue` 레이어 도입
- 지정가 주문 생성 → 다음 봉에서 체결 여부 판단
- 실서빙시 KIS API `지정가주문(TTTC0802U)` 연동

---

### A-4. Orchestrator 미구현 — M3/M5 로직 없음

**현상:** M3(당일 조건 부합 개수별 진입 비율), M5(완료 후 1개씩 차감) 로직이 코드 어디에도 없음.

**현재 구조의 문제:**
- 각 전략 `generate_signal`은 독립적으로 size를 결정 (고정값)
- 전략 간 당일 조건 부합 카운팅 공유 메커니즘 없음

**해결 방향:**
```python
class Orchestrator:
    def __init__(self, strategies, portfolio):
        self._daily_match_count: dict[date, int] = {}  # 날짜별 조건 부합 누적

    def get_entry_size(self, today: date) -> float:
        count = self._daily_match_count.get(today, 0)
        size_table = {1: 0.50, 2: 0.40, 3: 0.33, 4: 0.22}
        return size_table.get(min(count, 4), 0.13)

    def on_trade_executed(self, today: date):
        # M5: 완료 후 1개 차감
        self._daily_match_count[today] = max(
            self._daily_match_count.get(today, 0) - 1, 0
        )
```

---

### A-5. `bargain_buy.py:176` — size 하드코딩 (C-3 잔재)

```python
# 현재 코드
return Signal(
    action=Action.BUY,
    ticker=ticker,
    size=0.5,  # 하드코딩 — M3 규칙 미반영
    ...
)
```

**해결:** Orchestrator에서 M3 기반 size를 주입하거나, `size=None`으로 설정 후 Orchestrator가 결정.

---

### A-6. `bargain_buy.py:166~190` — 복수 종목 동시 충족시 첫 종목만 반환 (W-3)

```python
# 현재 코드
for ticker, cfg in self._ticker_params.items():
    if ...:
        return Signal(Action.BUY, ticker, ...)  # 첫 번째만 반환
```

**영향:** CONL, SOXL 동시 폭락시 CONL만 처리, SOXL 기회 놓침.

**해결:** `generate_signals() -> list[Signal]` 형태로 변경, 우선순위 또는 전부 반환.

---

### A-7. `jab_seth.py` — 17:30 시간 조건 누락 (W-7)

```python
# jab_soxl.py (정상)
if market.time.hour < 17 or (market.time.hour == 17 and market.time.minute < 30):
    return False

# jab_seth.py (누락) — check_entry에 시간 조건 없음
```

**영향:** SETH가 장중 어느 시간에도 진입 가능 → M3 규칙(17:30~06:00) 위반.

---

### A-8. 리츠 과열 공격 조절 모드 — 구현 없음 (신규 이슈)

**현상:** `reit_risk.py`가 트리거 발동시 `"*leveraged"` 전체 매도 신호만 보냄. 아래 로직 전혀 없음:
- SOXL → SOXX 종목 교체
- ROBN → HOOD 종목 교체
- GDXU → GLD 종목 교체
- 교체 종목 목표 수익률 × 50%
- 전체 전략 목표 수익률 −0.5%

**해결 방향:**
```python
# reit_risk.py 또는 AssetModeManager에 추가
REIT_OVERHEAT_SUBSTITUTES = {
    "SOXL": "SOXX",
    "ROBN": "HOOD",
    "GDXU": "GLD",
}
REIT_TARGET_MULTIPLIER = 0.5   # 교체 종목 목표 50%
REIT_GLOBAL_TARGET_DEDUCT = 0.5  # 전체 전략 목표 -0.5%
```

---

### A-9. 수익금 분배 로직 — 구현 없음 (신규 이슈)

**현상:** 매도 후 수익금을 SOXL, ROBN, GLD, CONL 각 1주씩 1일 1회 구매하는 로직 없음.

**현재 `execute_sell` 구조:** 단순히 cash에 합산 후 종료.

**해결 방향:**
- `ProfitDistributor` 클래스 신설
- 하루 수익금 합산 후 마감 후 자동 분배 실행
- 분배 우선순위: SOXL → ROBN → GLD → CONL (수익금 소진시 중단)

---

## 7. 확인 필요 — 모호하거나 이상한 지표

아래 항목들은 CSV 원문이 모호하거나, 조건이 현실적으로 달성 어렵거나, 해석이 여러 가지 가능한 것들입니다.
**태준님 확인 후 반영이 필요합니다.**

### Q-1. XRP >= +5.0% (잽모드 BITU 조건)

> CSV: `XXRP +5.0% 이상`

- 다른 코인(BTC +0.9%, ETH +0.9%, SOL +2.0%)에 비해 **XRP만 5%로 극단적으로 높음**
- XRP가 하루에 +5% 이상 움직이는 날은 매우 드물어서, 이 조건 때문에 잽모드 BITU 진입 자체가 거의 불가능할 수 있음
- **확인:** 5%가 맞는지? 혹시 0.5% 또는 2.0%?

---

### Q-2. SETH 진입 조건 "하락이 12퍼센트 이하"

> CSV: `POLYAMARKET ETH 기준 하락이 12퍼센트 이하인경우`

- **해석 1:** Polymarket에서 ETH 하락 확률이 12% 이하 → 하락 가능성 낮은데 왜 숏?
- **해석 2:** Polymarket에서 ETH 가격이 12% 이하로 떨어질 거라는 예측 → 숏 진입
- 현재 코드: `1 - eth_up >= 0.12` (eth_up이 88% 이하 = 하락 확률 12% 이상)
- **확인:** 어느 해석이 맞는지?

---

### Q-3. CONL 목표 수익률 +188%

> CSV: `188% 상승까지 홀딩`

- 2배 레버리지 ETF가 +188% 상승하려면 기초자산이 약 +94% 상승해야 함
- CONL(코인베이스 2x)이 -80% 폭락 후 원래 가격으로 복귀하면: `12.5 → 62.5 = +400%`이므로 이론적으로 가능하긴 함
- 하지만 레버리지 ETF의 시간가치 감쇠(volatility decay)로 실제 회복률은 훨씬 낮을 수 있음
- **확인:** 188이라는 숫자의 근거? 혹시 다른 수치?

---

### Q-4. SOXL 진입 조건 -90.5%

> CSV: `하락폭이 최저가 90.5 퍼센트 의 폭락이 나온경우`

- 3년 최고가 대비 -90.5% → 3배 레버리지 ETF에서는 가능 (기초자산 ~30% 하락시)
- **그런데 90.5%라는 소수점이 매우 구체적** — 과거 특정 시점 기준인지?
- 다른 종목은 정수% (80, 89, 73 등)
- **확인:** 90.5%가 정확한 값인지? 90%?

---

### Q-5. 잽모드 GLD 조건 방향 불일치

> - 잽모드 SOXL: `GLD >= +0.1%` (금 상승 OK)
> - 잽모드 BITU: `GLD >= +0.1%` (금 상승 OK)
> - 잽모드 TSLL: `GLD <= +0.3%` (금 상승 제한)
> - 잽모드 SETH: `GLD >= +0.01%` (금 양전)

- SOXL/BITU는 금이 올라도 매수 OK
- TSLL은 금이 0.3% 이상이면 매수 금지
- **확인:** TSLL의 GLD 조건이 `<= +0.3%`이 맞는지? `>= +0.3%`이 아닌지?

---

### Q-6. BRKU 하락 진입 기준 여러 번 변경

> CSV에서 BRKU 진입 기준이 3번 다르게 나옴:
> - 21:56 → `-26%`
> - 22:10 정리 → `-30%`
> - 최종 정리 → `-32%`

- 현재 코드: `-32%` (최종 정리본 기준)
- **확인:** 최종값이 32%가 맞는지?

---

### Q-7. ETHU 추가매수 "10퍼센트 더 매수"

> CSV: `10퍼센트더 하락시 10퍼센트 더 매수를 한다`

- 다른 종목: 추가 하락시 "나머지 전액" 또는 "50%" 매수
- ETHU만 "10% 더" → **전체 자본의 10%인지, 기존 매수의 10%인지 모호**
- 현재 코드: `add_size: 0.1` (10%)
- **확인:** 전체 자본 대비 10%? 아니면 기존 포지션 대비 10%?

---

### Q-8. 섹터 로테이션 "금" 섹터 빠짐

> CSV: `비트코인 / 반도체 / 금 / 은행중`

- 4대 섹터: 비트코인, 반도체, 금, 은행
- 그런데 CSV에 **금이 1위일 때 어떤 종목을 매수하는지 언급이 없음**
  - BTC 1위 → SOXL
  - 반도체 1위 → ROBN
  - 은행 1위 → GDXU
  - 금 1위 → ???
- **힌트 (2026-02-20):** 리츠 과열 공격 조절 모드에서 `GDXU → GLD` 교체 규칙이 신설됨. 금 섹터 1위일 때도 **GLD 매수**일 가능성 있음. 단 추측이므로 확인 필요.
- **확인:** 금이 1위 섹터일 때의 매수 규칙? (GLD인지 다른 종목인지)

---

### Q-9. SK리츠 관련 조건 — 숫자 확인

> CSV에서 SK리츠 관련 조건이 여러 개:
> - `SK리츠가 1퍼센트 하락시 매수를 조심` (GDXU 매수시)
> - `SK리츠가 중간에 1.5퍼센트이상 하락시에는 롱포지션을 집중`
> - `평균적으로 1.0퍼센트 이상인 날에는 조심해서 매수 매도`

- "조심" / "집중" 같은 표현은 **알고리즘으로 구현하기 모호**
- **힌트 (2026-02-20):** 리츠 과열 공격 조절 모드 신설로 "조심" 개념이 일부 구체화됨:
  - 리츠 과열시 → 레버리지 종목을 비레버리지로 교체 (SOXL→SOXX 등)
  - 리츠 과열시 → 목표 수익률 ×50% + 전체 −0.5%
  - "조심" = 비레버리지 교체 + 목표 하향으로 해석 가능 (추측, 확인 필요)
- **확인:** "조심" / "집중"을 위의 리츠 과열 조절 모드와 동일하게 적용하는지? 별도 규칙인지?

---

### Q-10. SNXX, OKLL 종목 확인

- **SNXX**: 정확한 ETF명 / 기초자산 미확인
- **OKLL**: 정확한 ETF명 / 기초자산 미확인
- 두 종목 모두 주요 ETF DB에서 검색 어려움
- **확인:** 정확한 티커명과 기초자산

---

### Q-11. Polymarket "NASDAQ 상승 기대치" 데이터 매핑

> CSV: `POLYAMARKET : NASDAQ 51% 이상 상승`

- 현재 Polymarket 데이터: `btc_up`, `eth_up` 필드는 확인됨
- **`ndx_up` (나스닥 상승 확률) 필드가 실제 Polymarket에 있는지?**
- Polymarket에 "NASDAQ up or down" 마켓이 상시 운영되는지 확인 필요
- **확인:** Polymarket에서 NASDAQ 관련 어떤 마켓을 보는지?

---

## 8. 현재 엔진 파일 구조

```
strategies/taejun_attach_pattern/      (17 files, ~100KB)
├── base.py              # BaseStrategy, MarketData, Signal, Position
├── registry.py          # @register + get_strategy()
├── fees.py              # FeeCalculator (왕복 0.74%)
├── portfolio.py         # PortfolioManager (자금배분, 충돌해소)
├── params.py            # 11개 전략 파라미터
├── __init__.py          # 패키지 + 자동 등록
│
├── jab_soxl.py          # A. 잽모드 SOXL
├── jab_bitu.py          # B. 잽모드 BITU
├── jab_tsll.py          # C. 잽모드 TSLL
├── jab_seth.py          # D. 숏 잽모드 SETH
├── vix_gold.py          # E. VIX → GDXU
├── sp500_entry.py       # F. S&P500 편입
├── bargain_buy.py       # G. 저가매수
├── short_macro.py       # H. 숏포지션 전환
├── reit_risk.py         # I. 리츠 리스크
├── sector_rotate.py     # J. 섹터 로테이션
└── bank_conditional.py  # K. 조건부 은행주
```

---

## 9. 코드화 이슈 (2026-02-20 신규 항목)

> 2026-02-20에 추가된 규칙들을 코드로 구현할 때 발생하는 이슈 정리.
> 기존 A-1~A-9는 섹션 6 참조.

---

### CI-1. M1 — 지정가 체결 레이어 신설

**이슈:**
- `execute_buy` / `execute_sell` 모두 `prices.get(ticker, 0)`으로 즉시 체결 → 사실상 시장가
- 지정가 주문 상태(Pending) 관리 클래스 없음
- 미체결 주문의 만료 처리 기준 없음 (당일 취소? GTC? 재시도 횟수?)

**필요 설계:**

| 항목 | 내용 |
|------|------|
| `LimitOrder` 클래스 | 주문가, 종목, 수량, 만료시각, 상태(pending/filled/cancelled) |
| `LimitOrderQueue` | 미체결 주문 큐 관리, 봉마다 체결 여부 판단 |
| 백테스트 체결 규칙 | 다음 봉 시가 ≤ 지정매수가 → 체결 / 미충족 → pending 유지 |
| 실서빙 연동 | KIS API `지정가주문(TTTC0802U)` + 체결 확인 polling |

**avg_price 문제:** 지정가 미체결 상태에서 평균가 계산 불가 → 체결 확정 후에만 `Position` 생성

---

### CI-2. M2 — "즉시 행동"의 구현 단위

**이슈:**
- "즉시"가 분봉 기준인지, 초봉 기준인지 미정
- 조건 달성 봉과 주문 제출 봉 사이에 가격이 이미 움직인 경우 지정가 기준 불명확
- 네트워크·API 지연 발생시 "즉시" 보장 불가

**필요 결정:**

| 질문 | 선택지 |
|------|--------|
| 조건 달성 즉시 지정가 기준 | A. 조건 달성 봉의 종가 / B. 다음 봉 시가 |
| API 지연 허용 범위 | A. 1분 이내 / B. 당일 내 |

---

### CI-3. M3 — 시간 범위 및 거래일 캘린더

**이슈:**

| 항목 | 문제 |
|------|------|
| NYSE 거래일 캘린더 | 미국 공휴일 데이터 별도 관리 필요 (`pandas_market_calendars` or 직접 구현) |
| DST(서머타임) | 미국 시장 개장 KST 기준: 동절기 23:30, 하절기 22:30 — 매년 변동 |
| 날짜 경계 | 17:30~06:00은 자정을 넘어감 → `date` 기준 처리 주의 (금요일 17:30 ~ 토요일 06:00 포함) |
| 한국 공휴일 | KIS API 접근 가능 여부에 따라 한국 공휴일도 체크 필요 여부 결정 |
| 주말 처리 | 금요일 06:00 이후 ~ 월요일 17:30 완전 비활성 → 상태 누락 없이 처리 필요 |

---

### CI-4. M3 — 진입 비율 카운팅 충돌

**이슈:**
- 각 전략 `generate_signal`은 독립 호출 → 전략 간 카운트 공유 불가
- 같은 봉에서 여러 전략이 동시 BUY → 처리 순서에 따라 비율이 달라짐
- 진입 비율 누적시 자본 초과 위험

**예시 문제:**

| 상황 | 결과 |
|------|------|
| jab_soxl(1번째) + jab_bitu(2번째) 동시 달성 | 1번째는 50% 진입, 2번째는 40% 진입 → 총 90% 투입 |
| jab_soxl + jab_bitu + jab_tsll 동시 | 50+40+33 = 123% → 자본 초과 |

**해결 방향:** Orchestrator에서 당일 전체 BUY 시그널 수를 먼저 집계 → 한꺼번에 비율 분배

---

### CI-5. M5 — 차감 로직 상태 관리

**이슈:**
- 차감 시점 미확인 (P-3): 매수 완료시? 매수+매도 세트 완료시?
- 날짜 자정 경계에서 카운트 초기화 시점 (17:30 기준? 00:00 기준?)
- 차감 후 음수가 되면 0 처리 or 다음 날로 이월?

**필요 결정:**

| 질문 | 선택지 |
|------|--------|
| 차감 시점 | A. 매수 체결 완료시 / B. 매도 체결 완료시 / C. 매수+매도 세트 완료시 |
| 카운트 초기화 | A. 매일 00:00 / B. 매일 17:30 (장 시작 기준) |

---

### CI-6. 수익금 분배 — ProfitDistributor 설계 이슈

**이슈:**

| 항목 | 문제 |
|------|------|
| 분배 시점 | 매도 즉시 분배 vs 장 마감 후 일괄 분배 — 즉시 분배시 당일 추가 거래와 충돌 |
| 손실 거래시 | pnl < 0이면 분배 skip? 누적 손실에서 차감? |
| 수익금 부족 | 4주 모두 살 금액 미달시 처리 방식 미확인 (P-1) |
| 구매 순서 | 동시 vs 순차 미확인 (P-1) |
| 가격 데이터 없음 | SOXL 등 특정 종목 가격 조회 실패시 해당 종목 skip? 전부 중단? |
| M1 적용 여부 | 수익금 분배 매수도 지정가 적용인지? |

---

### CI-7. 리츠 과열 공격 조절 모드 — 종목 교체 구현

**이슈:**

| 항목 | 문제 |
|------|------|
| 교체 처리 위치 | 각 전략 내부(jab_soxl이 리츠 과열 여부 직접 확인) vs Orchestrator 후처리(시그널 ticker 교체) |
| 기존 포지션 처리 | 리츠 과열 발동시 보유중인 SOXL 포지션 → 그대로 유지? 즉시 매도? |
| 목표수익률 적용 범위 | 신규 진입분에만 ×50% 적용? 기존 포지션도 소급 적용? |
| params 런타임 수정 | `JAB_SOXL["target_pct"]` 동적 변경 → 다른 전략에 사이드 이펙트 위험 → 복사본 사용 필요 |
| 해제 처리 | 90일 후 리츠 과열 해제시 원래 종목/목표수익률 복귀 로직 필요 |
| P-2 미확인 | "제외항" 범위 확인 전까지 전체 −0.5% 적용 범위 구현 불가 |

---

### CI-8. C-1 수수료 0.74% — 전략별 적용 방식

**이슈:**

| 전략 | 특이사항 |
|------|---------|
| 저가매수 (G) | 목표 188%/320% — 수수료 0.74% 영향 미미, 별도 처리 불필요할 수 있음 |
| 분할매도 (sell_splits=6) | 매 회 매도시 수수료 부과 → 총 수수료 = 매수 0.37% + 매도 0.37%×6 = 2.59% → 목표 설정시 반영 필요 |
| SETH/BAC | 목표 0.8% net → gross = 0.8 + 0.74 = **1.54%** 기준으로 체결 판단 |
| 리츠 과열 조절 모드 | SOXX/HOOD/GLD는 이미 목표 ×50% → 수수료 차감 후 실질 목표가 음수가 될 수 있음 |

**필요 신설:**
- `FeeCalculator.gross_target(net_target_pct) -> float` 메서드
- `check_exit`에서 gross 기준으로 비교하도록 전략별 수정

---

### CI-9. SETH/BAC 목표수익률 params 수정

**변경 필요 파일:** `params.py`

```python
# 수정 전
JAB_SETH = { "target_pct": 0.5, ... }
BANK_CONDITIONAL = { "target_pct": 0.5, ... }

# 수정 후
JAB_SETH = { "target_pct": 0.8, ... }
BANK_CONDITIONAL = { "target_pct": 0.8, ... }
```

**주의:** C-1과 연동하여 gross 기준은 각각 1.54%로 체결 판단

---

### CI-10. 코드화 블로커 정리 (미확인 → 구현 불가 항목)

아래 항목은 **P-1~P-4 확인 전 코드 반영 불가:**

| 블로커 | 막힌 구현 |
|--------|---------|
| P-1 미확인 | `ProfitDistributor` 분배 순서 / 수익금 부족 처리 |
| P-2 미확인 | 리츠 과열시 −0.5% 적용 범위 |
| P-3 미확인 | M5 차감 시점 / "각각" 범위 |
| P-4 미확인 | TSLL 200만원 한도 vs M3 비율 우선순위 |

---

## 10. 다음 단계

1. **태준님 확인 (Q-1 ~ Q-11)** → 모호한 지표 확정
2. **Critical 수정 (C-1 ~ C-3)** → 수수료 0.74% 반영, 지정가 체결, M3 동적 비율
3. **알고리즘 이슈 수정 (A-1 ~ A-10)** → 우선순위별 처리
4. **마스터 플랜 Orchestrator 구현** → M1/M3/M5 로직
5. **리츠 과열 공격 조절 모드 구현** → 종목 교체 + 목표수익률 조정
6. **수익금 분배 ProfitDistributor 구현** → 1일 1주 SOXL/ROBN/GLD/CONL
7. **Warning 이슈 (W-5 우선)** → reit_risk.py datetime.now() → market.time
