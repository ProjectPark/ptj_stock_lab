# Trading Analysis Playbook (Pro Trader + Pro Coder)

## 0) 문서 목적

이 문서는 현재 `toss` 거래내역 데이터와 이후 결합할 주변 데이터(시장/거시/이벤트)를 기반으로,  
전문 트레이더와 전문 코더 관점에서 성과를 분해하고 개선 포인트를 찾기 위한 실무형 분석 표준이다.

핵심 목표는 3가지다.

1. 성과가 난 이유와 깨진 이유를 분리한다.
2. 재현 가능한 방식으로 가설을 검증한다.
3. 다음 버전 매매 기법에 바로 연결 가능한 개선안을 만든다.

---

## 1) 현재 보유 데이터와 역할

### 1.1 주요 파일

- `toss/stock_analysis_ready.csv`: 분석 기준 메인 테이블  
- `toss/held_symbols_202402_202602.csv`: 종목별 보유 구간/순현금흐름 요약  
- `toss/profit_interval_summary.md`: 1일/5일/10일 수익 구간 및 상위 종목 요약  
- `toss/rolling_windows_profit_top_nonoverlap.csv`: 1/5/10일 상위 수익 윈도우 원본  

### 1.2 현재 데이터로 가능한 분석

- 실현 관점 현금흐름 분석(일/주/월, 종목, 구간)
- 수익 집중도(상위 구간 기여율)
- 보유 기간과 거래 횟수 기반 스타일 분석
- 전략 특성 추정(레버리지/테마 편중, 이벤트 의존도)

### 1.3 현재 데이터만으로 어려운 분석

- 미실현 손익 포함 포트폴리오 가치 곡선
- 체결 슬리피지/시장충격 정밀 추정
- 진입 시점의 시장 상태(변동성, 모멘텀, 이벤트) 기반 인과 추정

---

## 2) 분석 원칙 (트레이더+코더 공통)

1. `성과(What)`와 `원인(Why)`을 분리한다.  
2. 원인 추정은 반드시 대조군/반사실(counterfactual)을 둔다.  
3. 샘플 수가 적은 구간 결과는 확률 불확실성을 같이 표기한다.  
4. 고수익 구간 1~2개가 전체 성과를 지배하는지 항상 먼저 본다.  
5. 개선안은 전략 규칙/포지션 사이징/리스크 한도/집행 방식으로 분해해서 제시한다.

---

## 3) 분석 프레임워크 (7단계)

## Step 1. 데이터 정합성 검증 (Data QA)

분석 전 반드시 아래를 통과해야 한다.

- 날짜 파싱 100% 성공
- 금액 컬럼(`signed_amount`) 결측/이상치 비율 확인
- 거래 타입 맵핑 무결성 (`stock_buy`, `stock_sell`, `dividend`, `fee`, `tax`)
- 종목명 표준화 룰 적용 (동일 종목의 문자열 변형 통합)
- 중복 레코드 검사 (`date`, `type`, `symbol_name`, `amount` 기반)

권장 산출물:

- `qa_report.md`
- `symbol_mapping.csv` (정규화 사전)

## Step 2. 성과 분해 (P&L Decomposition)

수익을 아래 축으로 동시에 분해한다.

1. 시간축: 1일/5일/10일/월/분기
2. 종목축: 상위 기여 종목, 하위 기여 종목
3. 행동축: 매수 횟수, 매도 횟수, 보유 일수, 거래 강도
4. 구조축: 레버리지/비레버리지, 섹터/테마, 이벤트 민감형/비민감형

핵심 지표:

- `Net Cash Flow`
- `Profit Concentration Ratio`  
  예: 상위 N일 수익합 / 전체 양(+)수익합
- `Burst Score`  
  예: (상위 5일 수익합) / (양(+)수익합)
- `Holding Efficiency`  
  예: 순현금흐름 / 보유일수
- `Trade Efficiency`  
  예: 순현금흐름 / (매수+매도 이벤트 수)

## Step 3. 리스크 분해 (Risk Decomposition)

현재 데이터에서 가능한 범위의 리스크 분석:

- 수익 발생일 대비 손실 발생일 비율
- 월별 성과 분포의 왜도(positive months vs negative months)
- 단일 구간 의존도(특정 5일/10일 윈도우 과집중)
- 종목 편중도(HHI 또는 Top-k 점유율)

주변 데이터 결합 후 확장:

- MDD, Calmar, Sortino, CVaR(95%)
- 변동성 레짐별 성과 (고/중/저)
- 지수 급락 구간에서의 손익 탄력성(beta-like response)

## Step 4. 레짐/이벤트 민감도 분석

수익이 어떤 환경에서 발생하는지 분해한다.

필수 결합 데이터:

- 지수: `SPY`, `QQQ`, `SOXX`
- 변동성: `VIX`
- 거시: 미국 2Y/10Y 금리, DXY
- 크립토 노출 확인용: `BTC`, `ETH`
- 이벤트 캘린더: FOMC, CPI, 고용지표, 대형주 실적 발표

분석 방법:

1. 거래일을 레짐으로 라벨링 (예: VIX 20 이상/미만)
2. 레짐별 평균 손익, 승률, 손익비 비교
3. 이벤트 윈도우(-2~+2일) 성과 비교
4. 이벤트 없는 통제구간과 차이 검정

## Step 5. 전략 행태(Behavioral Signature) 추출

전략이 실제로 어떤 기법인지 데이터로 정의한다.

확인 포인트:

- 추세추종형: 강한 상승일/상승 직후에 집중 진입하는가
- 평균회귀형: 급락 후 반등 구간에서 수익이 집중되는가
- 이벤트 추격형: 뉴스/실적 직후 과도한 거래가 있는가
- 스케일링형: 보유 중 분할매수/분할청산 패턴이 반복되는가

정량 특징(Features):

- 최근 n일 수익률 대비 거래량 비율
- 진입 시점 변동성(ATR, realized vol)
- 포지션 증감 속도(Delta Position / Day)
- 손익 실현까지 소요 시간(Time-to-profit)

## Step 6. 가설 검증 (Statistical Validation)

권장 가설 예시:

- H1: 고수익은 고변동성 레짐에서만 유의하게 발생한다.
- H2: 레버리지 상품은 평균 수익 기여는 높지만 분산이 과도하게 크다.
- H3: 1일 급등일 추격 진입은 기대값이 낮고 tail risk가 높다.

검증 절차:

1. 시계열 분할: `Train/Validation/Test` (Walk-forward)
2. 블록 부트스트랩으로 신뢰구간 추정
3. 다중검정 보정(BH/FDR)
4. Out-of-sample 성과만 의사결정에 사용

## Step 7. 실행 개선안 도출 (Actionable Design)

개선안은 반드시 아래 4축으로 제출한다.

1. 진입 규칙: 어떤 조건에서만 진입할지
2. 청산 규칙: 익절/손절/시간기반 청산
3. 사이징 규칙: 레짐별 익스포저 캡
4. 리스크 한도: 일손실/주손실/단일종목 손실 제한

예시 개선안 템플릿:

- Rule A: `VIX > X` 구간에서 레버리지 ETF 최대 비중 `Y%`로 제한
- Rule B: 진입 후 `N`일 내 목표 미도달 시 강제 축소
- Rule C: 동일 테마 상관 종목 동시보유 상한 `K`개

---

## 4) 전문가형 분석 산출물 패키지

최종적으로 아래 파일이 나오면, 전략 재설계에 바로 쓸 수 있다.

1. `analysis/01_data_quality_report.md`
2. `analysis/02_pnl_decomposition.md`
3. `analysis/03_regime_event_study.md`
4. `analysis/04_risk_diagnostics.md`
5. `analysis/05_behavioral_signature.md`
6. `analysis/06_hypothesis_tests.md`
7. `analysis/07_strategy_recommendations.md`
8. `analysis/artifacts/*.csv` (중간 테이블)
9. `analysis/charts/*.png` (핵심 차트)

---

## 5) 코더 관점 구현 구조 (권장)

권장 디렉터리:

```text
analysis_pipeline/
  config/
    settings.yaml
  src/
    load_data.py
    normalize.py
    features.py
    pnl_decompose.py
    regime_label.py
    event_study.py
    hypothesis_test.py
    report_builder.py
  outputs/
    tables/
    charts/
    reports/
  notebooks/
```

개발 원칙:

1. 입력/출력 스키마를 고정하고 버전 태깅
2. 모든 중간 산출물을 CSV/Parquet로 저장
3. 파라미터는 코드 하드코딩 금지 (`settings.yaml`)
4. 리포트는 코드로 재생성 가능해야 함
5. 동일 입력이면 동일 결과(재현성) 보장

---

## 6) 주변 데이터 결합 후 정밀 분석 로드맵

## Phase A (빠른 진단, 1~2일)

1. 심볼 정규화 완성
2. 1일/5일/10일 수익구간 기여 종목 분해
3. 월별/종목별 집중도 차트 생성

## Phase B (심화 분석, 3~5일)

1. 시장 레짐 라벨링(VIX, 지수 추세)
2. 이벤트 스터디(FOMC, CPI, 실적)
3. 레버리지 vs 비레버리지 성과/위험 비교

## Phase C (전략 설계, 5~10일)

1. 후보 규칙 3~5개 정의
2. 워크포워드 백테스트
3. 리스크 한도 포함 실거래 친화 룰로 축소
4. 운영 모니터링 지표 정의

---

## 7) 바로 적용할 분석 질문 (우선순위)

1. 상위 1일/5일/10일 수익 구간은 어떤 공통 조건을 가졌나?
2. 수익 상위 종목은 진입 타이밍이 추세추종형인가 반등포착형인가?
3. 수익 기여는 높은데 리스크가 과도한 종목은 무엇인가?
4. 레버리지 비중 상한을 두면 장기 성과 분포가 개선되는가?
5. 급등 추격 진입을 제한하면 손익분포의 왼쪽 꼬리가 줄어드는가?

---

## 8) 의사결정 기준 (전문가용)

다음 조건을 동시에 만족해야 전략 개선안 채택:

1. Out-of-sample 기준 기대수익 유지 또는 개선
2. 최대 손실 꼬리(CVaR/MDD) 유의미한 축소
3. 성과가 특정 1개 구간에 과도하게 의존하지 않음
4. 거래 빈도/실행 복잡도가 운영 가능한 범위
5. 룰이 설명 가능하고 자동화 가능한 형태

---

## 9) 현재 리포트 기반 임시 결론 (초기 가설)

현재까지 관측된 패턴을 기준으로 한 초기 가설:

1. 수익은 소수 구간 집중형이며, 평시 성과가 약할 가능성
2. 레버리지/테마형 종목 노출이 성과와 변동성을 동시에 확대
3. 반복 진입/청산(스케일링) 기반 운용 흔적이 뚜렷함
4. 레짐 필터 없이 운용 시 월 단위 성과 분산이 커질 가능성

이 가설은 주변 데이터 결합 후 반드시 재검증해야 한다.

---

## 10) 다음 작업 제안

실전 분석 시작 시 우선 구현 권장 순서:

1. 종목명 정규화 테이블 확정 (`symbol_mapping.csv`)
2. 1/5/10일 상위 구간의 종목 기여도 분해 테이블 생성
3. VIX/지수 데이터 결합 후 레짐별 성과 리포트 작성
4. 워크포워드 검증 스크립트로 개선안 3개 비교

